<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>Boot Firmware - U-Boot Handoff &mdash; Boot SOM Firmware 2022.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Boot Firmware - PMU Overlay Config Object" href="bootfw_pmu_config_obj.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../index.html" class="icon icon-home"> Boot SOM Firmware
            <img src="../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SOM</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/index.html">Landing Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/creating_applications/latest/build/html/index.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kria_som_ubuntu_support/build/html/index.html">Ubuntu Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/index.html">Kria KV260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kr260/build/html/index.html">Kria KR260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/KRS/">Kria Robotics Stack</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Boot Firmware</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bootfw_overview.html">Boot Firmware Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootfw_image_selector.html">Boot Firmware - Image Selector</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootfw_image_recovery.html">Boot Firmware Image Recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootfw_pmu_config_obj.html">Boot Firmware - PMU Overlay Config Object</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Boot Firmware - U-Boot Handoff</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#u-boot-support-for-kria-som-variants">U-Boot support for Kria SOM Variants</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#starter-kit-som-production-som">Starter Kit SOM &amp; Production SOM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prioritized-boot-order">Prioritized Boot Order</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#boot-scr-linux-dt-decoupling-dt-selection">boot.scr - Linux DT Decoupling &amp; DT Selection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compilation-procedure-and-source-code">Compilation Procedure and Source Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Boot SOM Firmware</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Boot Firmware - U-Boot Handoff</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/bootfw_uboot_handoff.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="boot-firmware-u-boot-handoff">
<h1>Boot Firmware - U-Boot Handoff<a class="headerlink" href="#boot-firmware-u-boot-handoff" title="Permalink to this heading">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>In Kria Starter Kits pre-built firmware, U-Boot provides the functionality for the hand-off between the primary boot device (QSPI) and the secondary boot device (SD card default, others available). U-Boot will automatically identify the carrier card (CC) on which it is running, it then enables a full SOM + CC device tree, enables the CC peripherals via the PMU configuration object overlay APIs, and then searches a pre-defined peripheral device list for Linux boot artifacts, and then boots Linux with those artifacts.</p>
<p>The CC incremental PS subsystem peripherals using the PMU configuration overlay functionality described <a class="reference internal" href="bootfw_pmu_config_obj.html"><span class="doc">here</span></a>. The PMU overlay will enable permissions for the incremental devices not included in the SOM only boot configuration defined by FSBL. U-Boot will drive the PMU configuration overlay APIs dynamically via the power domain (PD) driver when it loads the integrated device tree (DT) for KV260 or KR260. U-Boot locks the PMU configuration overlay function after it has finished loading its EEPROM identified DT. The overall flow is outlined in this flow-chart below.</p>
<p><img alt="image" src="../_images/ubootflow.png" /></p>
<p>Xilinx also provides customers with “flat” KV260 and KR260 BSPs that contains a simpler U-Boot configuration without dynamic CC selection and peripheral enablement. However, U-Boot source code does have support for dynamic initialization of peripherals for users who needs more sophisticated setups.</p>
</div>
<div class="section" id="u-boot-support-for-kria-som-variants">
<h2>U-Boot support for Kria SOM Variants<a class="headerlink" href="#u-boot-support-for-kria-som-variants" title="Permalink to this heading">¶</a></h2>
<div class="section" id="starter-kit-som-production-som">
<h3>Starter Kit SOM &amp; Production SOM<a class="headerlink" href="#starter-kit-som-production-som" title="Permalink to this heading">¶</a></h3>
<p>U-Boot for Kria officially supports the Kria Starter Kits. The Starter Kit SOM and Production SOM are variants of the same hardware design.  The Starter Kit SOM (designated by SMK-K26) is a reduced functionality version  of Production SOM (designated by SM-K26) in that the eMMC non-volatile memory device is NOT populated in the Starter Kit configuration. The power-on “base” HW configuration (Starter Kit SOM) used by the pre-built boot firmware shall be the most reduced set of base SOM functionality. Then at the U-Boot, the platform pivots to either an integrated Starter Kit SOM + CC or a Production SOM + CC.</p>
<p><img alt="image" src="../_images/ubootflow_SMvsSMK.png" /></p>
</div>
<div class="section" id="prioritized-boot-order">
<h3>Prioritized Boot Order<a class="headerlink" href="#prioritized-boot-order" title="Permalink to this heading">¶</a></h3>
<p>Prior to 21.2, U-Boot will search for both the SD card and eMMC secondary boot devices; if both are detected it will provide a menu interface to you to select the desired Linux boot target.</p>
<p>From 22.1 onwards, there is no U-Boot boot menu during the boot process for SOM. The Xilinx pre-built BOOT.BIN implements a fixed device boot selection as defined by the CC identified. See the following boot device selection order for the KV and KR carrier cards. If a Production SOM is identified by its board-ID EEPROM then U-Boot first query the SOM local eMMC (mmc0) device for boot, before falling to the normal Starter Kit CC boot order.</p>
<p><img alt="image" src="../_images/ubootflow_KVvsKR.png" /></p>
</div>
</div>
<div class="section" id="boot-scr-linux-dt-decoupling-dt-selection">
<h2>boot.scr - Linux DT Decoupling &amp; DT Selection<a class="headerlink" href="#boot-scr-linux-dt-decoupling-dt-selection" title="Permalink to this heading">¶</a></h2>
<p>U-Boot uses boot.scr to help booting Linux with different device trees (DTs) provided in SD image.</p>
<p>Kria SOM has decoupled the device tree (DT) used by U-Boot firmware from the one selected and passed to Linux. This is to allow the BootFW (BOOT.BIN) and Linux image (SD card image) to have decoupled life-cycles. Note that DT for U-Boot is integrated into BOOT.BIN, while DTs for Linux are stored in the SD card boot partition.</p>
<p>The U-Boot boot script (boot.scr) has three functions:</p>
<ul class="simple">
<li><p>Select correct Linux DT from pre-built SOM + CC DTs in the Linux SD card boot partition.</p></li>
<li><p>Define Linux boot argument (bootargs) based on CC identified</p></li>
<li><p>Lock the PMU configuration object functionality to prevent enabling of any new power domain</p></li>
</ul>
<p>The pre-built U-Boot functionality provide U-Boot environment variables for boot.scr to use to drive the selection of the Linux DT. The following variables are used:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>env variable</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>board_name</td>
<td>SMK-K26-XCL2G</td>
<td>SOM board product name. Differentiates Starter vs. Production SOMs</td>
</tr>
<tr>
<td>board_rev</td>
<td>1</td>
<td>SOM board revision.</td>
</tr>
<tr>
<td>card1_name</td>
<td>SCK-KV-G</td>
<td>Carrier card product name.</td>
</tr>
<tr>
<td>card1_rev</td>
<td>1</td>
<td>Carrier card revision.</td>
</tr>
</tbody>
</table><p>An example boot.scr source code can be found below, it needs to be compiled by mkimage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>################
fitimage_name=image.ub
kernel_name=Image
ramdisk_name=ramdisk.cpio.gz.u-boot
rootfs_name=rootfs.cpio.gz.u-boot


# Close pmufw node so that linux can&#39;t send small fragments to pmufw
zynqmp pmufw node close

# Starter Kit default boot args
setenv bootargs &#39;earlycon console=ttyPS1,115200 clk_ignore_unused init_fatal_sh=1 cma=900M &#39;;

#Set boot parameters based on CC type
if test &quot;${card1_name}&quot; = &quot;SCK-KV-G&quot;; then
        setenv card_name sck-kv-g &amp;&amp; setenv bootargs ext4=/dev/mmcblk1p2:/rootfs $bootargs;
elif test &quot;${card1_name}&quot; = &quot;SCK-KR-G&quot;; then
        setenv card_name sck-kr-g &amp;&amp; setenv bootargs ext4=/dev/sda2:/rootfs $bootargs;
else #Assume Kria USB secondary boot device
        setenv card_name unknown &amp;&amp; setenv bootargs ext4=/dev/sda2:/rootfs $bootargs;
fi

#Set DT selection
if test &quot;${card1_name}&quot; = &quot;SCK-KV-G&quot;; then
        if test &quot;${card1_rev}&quot; = &quot;Z&quot; || test &quot;${card1_rev}&quot; = &quot;A&quot;; then
                #revA dtb also supports revZ boards
                dtb_name=SMK-zynqmp-${card_name}-revA
        elif test &quot;${card1_rev}&quot; = &quot;B&quot; || test &quot;${card1_rev}&quot; = &quot;1&quot;; then
                #revB dtb also supports rev1 boards
                dtb_name=SMK-zynqmp-${card_name}-revB
        fi
elif test &quot;${card1_name}&quot; = &quot;SCK-KR-G&quot;; then
        if test &quot;${card1_rev}&quot; = &quot;B&quot; || test &quot;${card1_rev}&quot; = &quot;1&quot;; then
                #revB dtb also supports rev1 dtb
                dtb_name=SMK-zynqmp-${card_name}-revB
        elif test &quot;${card1_rev}&quot; = &quot;A&quot;; then
                dtb_name=SMK-zynqmp-${card_name}-revA
        fi
else
        dtb_name=system
fi

for boot_target in ${boot_targets};
do
echo &quot;Trying to load boot images from ${boot_target}&quot;
if test &quot;${boot_target}&quot; = &quot;mmc0&quot; || test &quot;${boot_target}&quot; = &quot;mmc1&quot; || test &quot;${boot_target}&quot; = &quot;usb0&quot; || test &quot;${boot_target}&quot; = &quot;usb1&quot;; then
        if test -e ${devtype} ${devnum}:${distro_bootpart} /${fitimage_name}; then
                fatload ${devtype} ${devnum}:${distro_bootpart} 0x10000000 ${fitimage_name};
                bootm 0x10000000;
        fi
        if test -e ${devtype} ${devnum}:${distro_bootpart} /${kernel_name}; then
                fatload ${devtype} ${devnum}:${distro_bootpart} 0x00200000 ${kernel_name};
        fi
        if test -e ${devtype} ${devnum}:${distro_bootpart} /${dtb_name}.dtb; then
                fatload ${devtype} ${devnum}:${distro_bootpart} 0x00100000 ${dtb_name}.dtb;
        else
		echo &quot;Expected ${dtb_name} Not Found in FAT Partition, Booting with SOM only DTB&quot;
	fi
        if test -e ${devtype} ${devnum}:${distro_bootpart} /${ramdisk_name} &amp;&amp; test &quot;${skip_tinyramdisk}&quot; != &quot;yes&quot;; then
                fatload ${devtype} ${devnum}:${distro_bootpart} 0x04000000 ${ramdisk_name};
                booti 0x00200000 0x04000000 0x00100000
        fi
        if test -e ${devtype} ${devnum}:${distro_bootpart} /${rootfs_name} &amp;&amp; test &quot;${skip_ramdisk}&quot; != &quot;yes&quot;; then
                fatload ${devtype} ${devnum}:${distro_bootpart} 0x04000000 ${rootfs_name};
                booti 0x00200000 0x04000000 0x00100000
        fi
        booti 0x00200000 - 0x00100000
fi
done
</pre></div>
</div>
<p>The boot.scr can be found in the SD card after programming a .wic image, or it can be found in PetaLinux project (after petalinux-create command) in &lt;petalinux_project&gt;/pre-built/linux/images/boot.scr. the .scr file has been compiled, therefore there will be some binaries prior to the texted source code.</p>
<div class="section" id="compilation-procedure-and-source-code">
<h3>Compilation Procedure and Source Code<a class="headerlink" href="#compilation-procedure-and-source-code" title="Permalink to this heading">¶</a></h3>
<p>U-Boot is compiled with Yocto, and its recipe can be found <a class="reference external" href="https://github.com/Xilinx/meta-xilinx/blob/master/meta-xilinx-core/recipes-bsp/u-boot/u-boot-xlnx.inc">here</a>. <a class="reference external" href="https://docs.xilinx.com/v/u/2020.1-English/ug1144-petalinux-tools-reference-guide">PetaLinux documentation</a> contains information on U-Boot generation as well.</p>
<p>The <a class="reference external" href="github.com/Xilinx/u-boot-xlnx.git">source code for U-Boot</a> is on Xilinx github site as well.</p>
<p>boot.scr is compiled using mkimage, and more information can be found <a class="reference external" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/749142017/Using+Distro+Boot+With+Xilinx+U-Boot">here</a></p>
</div>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this heading">¶</a></h2>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License.</p>
<p>You may obtain a copy of the License at
<a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p align="center">Copyright&copy; 2021 Xilinx</p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bootfw_pmu_config_obj.html" class="btn btn-neutral float-left" title="Boot Firmware - PMU Overlay Config Object" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on August 1, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="https://pages.gitenterprise.xilinx.com/techdocs/Test/vvas/build/html/index.html#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>