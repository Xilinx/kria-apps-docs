<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
<!-- End Google Tag Manager -->
  <title>Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application &mdash; Kria™ SOM 2022.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform" href="vitis_platform_flow_smartcam_raspi_example.html" />
    <link rel="prev" title="Vivado Accelerator Flow Example" href="vivado_accel_example.html" /> 
</head>

<body class="wy-body-for-nav">

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
<!-- End Google Tag Manager --> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../index.html" class="icon icon-home"> Kria™ SOM
            <img src="../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SOM</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/">Landing Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/creating_applications.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/ubuntu_support.html">Ubuntu Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/bootfw.html">Boot Firmware</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/openamp.html">OpenAMP</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/dfx.html">Dynamic Function eXchange</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/ipmi_eeprom.html">IPMI EEPROM Design Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/yocto.html">Yocto Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/xen.html">XEN Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260-docs.html">Kria KV260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kr260-docs.html">Kria KR260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/KRS/">Kria Robotics Stack</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flows</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Development Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="vitis_accel_flow.html">Vitis Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vitis_platform_flow.html">Vitis Platform Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vivado_accel_flow.html">Vivado Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_cc_flow.html">Custom Carrier Card Flow</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vivado_accel_example.html">Vivado Accelerator Flow Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-platform">Obtaining Platform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-filter2d">Obtaining filter2d</a></li>
<li class="toctree-l3"><a class="reference internal" href="#altering-application-overlay">Altering Application/Overlay</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-bitstream-and-xclbin">Generate bitstream and .xclbin</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-steps-to-generate-shell-json-and-dtbo-file">Optional Steps to Generate shell.json and .dtbo file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compile-software-on-ubuntu-target">Compile software on Ubuntu Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-application-on-target">Run Application on Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vitis_platform_flow_smartcam_raspi_example.html">Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_cc_flow_example.html">Example - Creating a Platform for a Custom Carrier Card</a></li>
<li class="toctree-l2"><a class="reference internal" href="dtsi_dtbo_generation_smartcam_example.html">Example - Generating DTSI and DTBO Overlay Files for Smartcam</a></li>
<li class="toctree-l2"><a class="reference internal" href="kria_vitis_acceleration_flow/kria-vitis-acceleration.html">Kria Vitis Acceleration Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="baremetal.html">Bare-metal Flow Example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="target.html">On-target Utilities and Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootmodes.html">Setting Bootmodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="dtsi_dtbo_generation.html">Generating DTSI and DTBO Overlay Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="bitstream_management.html">Bitstream Management on Kria SOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="AI_customization.html">AI Customization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Releases</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/creating_applications/2021.1/build/html/index.html">2021.1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kria™ SOM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="examples.html">Examples</a> &raquo;</li>
      <li>Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/vitis_accel_flow_smartcam_filter2d_example.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="vitis-accelerator-flow-example-replacing-dpu-with-filter2d-accelerator-in-smartcam-application">
<h1>Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application<a class="headerlink" href="#vitis-accelerator-flow-example-replacing-dpu-with-filter2d-accelerator-in-smartcam-application" title="Permalink to this heading">¶</a></h1>
<p>This page will walk you through an example of replacing pre-processing and DPU in <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/smartcamera_landing.html">Smart Camera application</a>
with a simple accelerator (in this case, filter2d) in the Vitis Accelerator Flow. This particular example make use of the Makefile environment provided with <a class="reference external" href="https://github.com/Xilinx/kria-vitis-platforms">KV260 Vitis Repository</a>. Please first read <a class="reference internal" href="vitis_accel_flow.html"><span class="doc">Vitis Accelerator Flow</span></a> before trying this example.</p>
<p>This example was created with 22.1 tools and BSP and is based on Ubuntu. You will need Vitis. This application assumes that you are familiar with smartcam application, and have already booted Linux with a smartcam application running. If you have not yet done that, please go through <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/smartcamera_landing.html">smartcam application deployment</a>.</p>
<p>This example will generate 2 files - .bit.bin (PL bitstream) and .xclbin file for the specific accelerator. You will re-use .dtbo (device tree overlay), and shell.json file from smartcam platform because we are using the same platform.</p>
<div class="section" id="obtaining-platform">
<h2>Obtaining Platform<a class="headerlink" href="#obtaining-platform" title="Permalink to this heading">¶</a></h2>
<p>Since we are altering smartcam application only and not the platform, we will first need to get the platform smartcam is based on - kv260_ispMipiRx_vcu_DP. Detailed tutorial is at <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/build_vitis_platform.html">Creating Vitis Platform</a>. Here are the specific commands to use to generate the platform:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone --branch xlnx_rel_v2022.1 --recursive https://github.com/Xilinx/kria-vitis-platforms.git
<span class="nb">cd</span> <span class="nv">$workdir</span>/kria-vitis-platforms/kv260/platforms
<span class="nb">source</span> &lt;vitis path&gt;/settings64.sh
make platform <span class="nv">PFM</span><span class="o">=</span>kv260_ispMipiRx_vcu_DP
</pre></div>
</div>
<p>The platform will be available now in <code class="docutils literal notranslate"><span class="pre">kria-vitis-platforms/kv260/platforms/xilinx_kv260_ispMipiRx_vcu_DP_202110_1/</span></code>.</p>
</div>
<div class="section" id="obtaining-filter2d">
<h2>Obtaining filter2d<a class="headerlink" href="#obtaining-filter2d" title="Permalink to this heading">¶</a></h2>
<p>Filter2d RTL kernel can be found <a class="reference external" href="https://github.com/Xilinx/vck190-base-trd/tree/2022.1/overlays/filter2d/kernels/filter2d_pl/">here</a>. The repository was targeted for VCK190, a board containing a Versal device, but since it’s a soft IP, it works for Zynq MPSoC as well. In a separate folder, please download and extract the filter2d_pl and copy it to smartcam folder:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$workdir</span>
git clone --branch <span class="m">2022</span>.1 https://github.com/Xilinx/vck190-base-trd
<span class="nb">cd</span> vck190-base-trd
cp overlays/filter2d/kernels/filter2d_pl/ ../kria-vitis-platforms/kv260/overlays/examples/smartcam/ -r
</pre></div>
</div>
<p>In ```$workdir/kria-vitis-platforms/kv260/overlays/examples/smartcam//overlays/filter2d/kernels/filter2d_pl/Makefile update the LINK_CFG with a zynqmp.cfg instead of vck190.cfg:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>LINK_CFG ?= zynqmp.cfg
</pre></div>
</div>
<p>The zynqmp.cfg should be placed  in the same level as Makefile and vck190.cfg and has the following content:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[advanced]
param=compiler.addOutputTypes=hw_export
[vivado]
prop=run.impl_1.strategy=Performance_ExploreWithRemap
</pre></div>
</div>
<p>This will help meeting timing on Zynqmp Soc instead of vck190(Versal based)</p>
</div>
<div class="section" id="altering-application-overlay">
<h2>Altering Application/Overlay<a class="headerlink" href="#altering-application-overlay" title="Permalink to this heading">¶</a></h2>
<p>The next step is to alter the smartcam overlay. This is the overlay folder:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$workdir</span>/kria-vitis-platforms/kv260/overlays/examples/smartcam/
</pre></div>
</div>
<p>You will now find a Makefile in that level - open it up and remove DPU and add filter2d. We will first want to remove generation of DPU and its pre-processing. This means removing packing of .xo files for those 2 RTL kernels.</p>
<p>remove the following lines for DPU (in 3 separate places:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dpu_HDLSRCS=kernel_xml/dpu/kernel.xml\
	     scripts/package_dpu_kernel.tcl\
	     scripts/gen_dpu_xo.tcl\
	     ../../dpu_ip/Vitis/dpu/hdl/DPUCZDX8G.v\
	     ../../dpu_ip/Vitis/dpu/inc/arch_def.vh\
	     ../../dpu_ip/Vitis/dpu/xdc/*.xdc\
	     ../../dpu_ip/DPUCZDX8G_*/hdl/DPUCZDX8G_*_dpu.sv\
	     ../../dpu_ip/DPUCZDX8G_*/inc/function.vh\
             ../../dpu_ip/DPUCZDX8G_*/inc/arch_para.vh

dpu_TCL=scripts/gen_dpu_xo.tcl
DPU_KERN_NAME = DPUCZDX8G
dpu_xo = binary_container_1/dpu.xo


binary_container_1/dpu.xo: $(dpu_HDLSRCS)
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VIVADO) -mode batch -source $(dpu_TCL) -tclargs $@ $(DPU_KERN_NAME) ${TARGET} mpsoc


	cp ./binary_*/link/vivado/vpl/prj/prj.gen/sources_1/bd/*/ip/*_DPUCZDX8G_1_0/arch.json ./binary_*/sd_card
</pre></div>
</div>
<p>remove the following lines for preprocessing (PP):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>KERNEL = pp_pipeline_accel
KERNEL_XO = $(KERNEL)/$(KERNEL).xo

KERNEL_XO_FLAGS = -k $(KERNEL) -I$(XFOPENCV_INCDIR) -D__SDSVHLS__ -DHLS_NO_XIL_FPO_LIB --advanced.prop kernel.pp_pipeline_accel.kernel_flags=&quot;-std=c++0x&quot;

$(KERNEL_XO): xf_pp_pipeline_accel.cpp
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VPP) $(VPP_XO_FLAGS) -o $@ $&lt;
	-@$(RM) .Xil
</pre></div>
</div>
<p>Add filter2d .xo file generation and Makefile calls in 3 different places:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filter2d_xo = filter2d_pl/kernel/filter2d_pl_accel/filter2d_pl_accel.xo


$(BINARY_CONTAINER): $(filter2d_xo)
	$(VPP) $(VPP_LINK_FLAGS) -o $@ $(+)
	$(XBU) $(XBU_FLAGS) --input $(BINARY_CONTAINER) --output tmp.xclbin
	-@$(MV) tmp.xclbin $(BINARY_CONTAINER)
	-@$(RM) .Xil

$(filter2d_xo):
	$(MAKE) -C filter2d_pl/kernel
 
 
	$(MAKE) -C filter2d_pl/kernel clean
</pre></div>
</div>
<p>Remove invocation for strip_interconnects.tcl as we won’t need it:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--xp param:compiler.userPostSysLinkOverlayTcl=${DIR_PRJ}/prj_conf/strip_interconnects.tcl 
</pre></div>
</div>
<p>Replace the 2 kernels with filter2d kernel:
remove <code class="docutils literal notranslate"><span class="pre">dpu_pp_xo</span> <span class="pre">=</span> <span class="pre">$(KERNEL_XO)</span> <span class="pre">$(dpu_xo)</span></code>
add <code class="docutils literal notranslate"><span class="pre">dpu_pp_xo</span> <span class="pre">=</span>&#160; <span class="pre">$(filter2d_xo)</span></code></p>
<p>The resulting Makefile can be found in <a class="reference external" href="./example_src/filter2d_example/vitis_accel_example_smartcam_filter2d_makefile">example Makefile</a> you can compare it with the original Makefile <a class="reference external" href="https://github.com/Xilinx/kria-vitis-platforms/blob/xlnx_rel_v2022.1/kv260/overlays/examples/smartcam/Makefile">here</a></p>
<p>Next, we need to connect the filter2d accelerator to the processor subsystem. Open <code class="docutils literal notranslate"><span class="pre">prj_conf/prj_config_1dpu</span></code>, remove DPUCZDX8G and pp_pipeline_accel_1 clocks and connectivity, and connect filter2d to HP1, and set clock to 200Mhz:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[clock]
#freqHz=300000000:DPUCZDX8G_1.aclk
#freqHz=600000000:DPUCZDX8G_1.ap_clk_2
#freqHz=300000000:pp_pipeline_accel_1.ap_clk

freqHz=200000000:filter2d_pl_accel_0.ap_clk

[connectivity]
#sp=DPUCZDX8G_1.M_AXI_GP0:HP1
#sp=DPUCZDX8G_1.M_AXI_HP0:HP1
#sp=DPUCZDX8G_1.M_AXI_HP2:HPC1
#sp=pp_pipeline_accel_1.m_axi_gmem1:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem2:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem3:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem4:HP3

nk=filter2d_pl_accel:1:filter2d_pl_accel_0
sp=filter2d_pl_accel_0.frm_in:HP1
sp=filter2d_pl_accel_0.frm_out:HP1
sp=filter2d_pl_accel_0.kernel:HP1
</pre></div>
</div>
<p>Now you have finished all the modifications needed to replace preprocessor and DPU with filter2d.</p>
</div>
<div class="section" id="generate-bitstream-and-xclbin">
<h2>Generate bitstream and .xclbin<a class="headerlink" href="#generate-bitstream-and-xclbin" title="Permalink to this heading">¶</a></h2>
<p>You can now call the top level Makefile to generate the files required:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ../../../
make overlay <span class="nv">OVERLAY</span><span class="o">=</span>smartcam
</pre></div>
</div>
<p>The generated Vivado project will be located at:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$working_dir</span>/kria-vitis-platforms/kv260/overlays/examples/smartcam/binary_container_1/link/vivado/vpl/prj
</pre></div>
</div>
<p>You can open up the Vivado project to see how filter2d is connected into the system.</p>
<p>The generated bitfile and xclbin will be located at</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$working_dir</span>/kria-vitis-platforms/kv260/overlays/examples/smartcam/binary_container_1/link/int/system.bit   
<span class="nv">$working_dir</span>/kria-vitis-platforms/kv260/overlays/examples/smartcam/binary_container_1/*.xclbin
</pre></div>
</div>
<p>rename .xclbin file to <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code></p>
<p>Now you will need to convert system.bit to a .bit.bin file:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> overlays/examples/smartcam/binary_container_1/link/int/
<span class="nb">echo</span> <span class="s1">&#39;all:{system.bit}&#39;</span>&gt;bootgen.bif
bootgen -w -arch zynqmp -process_bitstream bin -image bootgen.bif
mv system.bit.bin filter2d.bit.bin
</pre></div>
</div>
<p>now you have a <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code> and <code class="docutils literal notranslate"><span class="pre">filter2d.bit.bin</span></code></p>
</div>
<div class="section" id="optional-steps-to-generate-shell-json-and-dtbo-file">
<h2>Optional Steps to Generate shell.json and .dtbo file<a class="headerlink" href="#optional-steps-to-generate-shell-json-and-dtbo-file" title="Permalink to this heading">¶</a></h2>
<p>Because we are re-using the same platform smartcam application is based on, we can re-use the smartcam shell.json and kv260-smartcam.dtbo file in the firmware folder as indicated in the following section. However, if you prefer, you can also generate them separatedly. Note that you will still need to download and install smartcam for the software dependencies this example uses.</p>
<p>Shell.json can be generated using the instruction <a class="reference external" href="target.md#shelljson-file">here</a>.</p>
<p>filter2d.dtbo can be generated by using the same <a class="reference external" href="https://github.com/Xilinx/kria-apps-firmware/blob/xlnx_rel_v2022.1/kv260/smartcam/kv260-smartcam.dtsi">.dtsi</a> file and compile using <a class="reference external" href="./dtsi_dtbo_generation.md#tools-and-input-required">dtc</a>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dtc -@ -O dtb -o filter2d.dtbo kv260-smartcam.dtsi
</pre></div>
</div>
</div>
<div class="section" id="compile-software-on-ubuntu-target">
<h2>Compile software on Ubuntu Target<a class="headerlink" href="#compile-software-on-ubuntu-target" title="Permalink to this heading">¶</a></h2>
<p>Next, we will need to boot Ubuntu, and compile the software on target. We want to download the kria-developer container because that contains the environment to compile our code:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker pull xilinx/kria-developer:latest
</pre></div>
</div>
<p>Then load docker container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>```bash
docker run \
--env=&quot;DISPLAY&quot; \
-h &quot;xlnx-docker&quot; \
--env=&quot;XDG_SESSION_TYPE&quot; \
--net=host \
--privileged \
--volume=&quot;$HOME/.Xauthority:/root/.Xauthority:rw&quot; \
-v /tmp:/tmp \
-v /dev:/dev \
-v /sys:/sys \
-v /etc/vart.conf:/etc/vart.conf \
-v /lib/firmware/xilinx:/lib/firmware/xilinx \
-v /run:/run \
-it xilinx/kria-developer:latest bash
```
</pre></div>
</div>
<p>in the docker container, cd to /tmp and clone the git repo and build the filder2d app. We want to use /tmp because that folder is accessible inside and outside containers. However, note that the files there may not persist through reboot.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /tmp/
git clone --branch <span class="m">2022</span>.1 https://github.com/Xilinx/vck190-base-trd.git
<span class="nb">cd</span> vck190-base-trd/overlays/filter2d/apps/filter2d-notebooks/filter2d-notebooks
mkdir build<span class="p">;</span>
<span class="nb">cd</span> build<span class="p">;</span>
cmake .. <span class="o">&amp;&amp;</span> make -j <span class="o">&amp;&amp;</span>make install
</pre></div>
</div>
<p>This produces 2 files we will require and copy to /tmp/ folder</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp /usr/local/lib/vvas/libvvas_xfilter2d_pl.so /tmp/
cp /usr/local/share/vvas/base-trd/kernel_xfilter2d_pl.json /tmp/
</pre></div>
</div>
</div>
<div class="section" id="run-application-on-target">
<h2>Run Application on Target<a class="headerlink" href="#run-application-on-target" title="Permalink to this heading">¶</a></h2>
<p>This application assumes that you are familiar with smartcam application and knows how to booted Linux with a smartcam application running. If you have not yet done that, please go through <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/smartcamera_landing.html">smartcam application deployment</a>.  The following commands in target (KV260) will download smartcam and their dependencies:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker pull xilinx/smartcam:2022.1
</pre></div>
</div>
<p>With smartcam application downloaded, we have most of the software dependencies needed to run gstreamer, as well as the .dtbo file and shell.json file. Note that because we reused the same platform from smartcam, we can re-use the .dtbo file from smartcam.</p>
<p>The filter2d accelerator we included only takes YuY2 format, while our MIPI sensors are in NV12 format. Therefore, we need to find a compatible video to try the filter2d with. In this case we googled and downloaded bbb_sunflower_1080p_30fps_normal.mp4 from <a class="reference external" href="https://mirror.clarkson.edu/blender/demo/movies/BBB/">here</a> or <a class="reference external" href="http://ftp.vim.org/ftp/ftp/pub/graphics/blender/demo/movies/BBB/">here</a> and placed them in /tmp/bbb_sunflower_1080p_30fps_normal.mp4. The /tmp folder is accessible by ubuntu or by containers.</p>
<p>Transfer  <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code> and <code class="docutils literal notranslate"><span class="pre">filter2d.bit.bin</span></code> to target KV260 using scp or your chosen method. On target, make a new filter2d directory and copy needed files into directory:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo mkdir /lib/firmware/xilinx/filter2d
// sudo cp /lib/firmware/xilinx/kv260-smartcam/kv260-smartcam.dtbo /lib/firmware/xilinx/filter2d/filter2d.dtbo
sudo cp /lib/firmware/xilinx/kv260-smartcam/shell.json /lib/firmware/xilinx/filter2d/
sudo cp filter2d.dtbo /lib/firmware/xilinx/filter2d/filter2d.dtbo
sudo cp filter2d.bit.bin /lib/firmware/xilinx/filter2d/
sudo cp filter2d.xclbin /lib/firmware/xilinx/filter2d/
</pre></div>
</div>
<p>modify  <code class="docutils literal notranslate"><span class="pre">/tmp/kernel_xfilter2d_pl.json</span></code> so that <code class="docutils literal notranslate"><span class="pre">xclbin-location</span></code> points to ```/lib/firmware/xilinx/filter2d/filter2d.xclbin`` location.</p>
<p>Now load the new application with filter2d firmware and smartcam container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo xmutil desktop_disable
sudo xmutil unloadapp
sudo xmutil loadapp filter2d

docker run <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;DISPLAY&quot;</span> <span class="se">\</span>
-h <span class="s2">&quot;xlnx-docker&quot;</span> <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;XDG_SESSION_TYPE&quot;</span> <span class="se">\</span>
--net<span class="o">=</span>host <span class="se">\</span>
--privileged <span class="se">\</span>
--volume<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.Xauthority:/root/.Xauthority:rw&quot;</span> <span class="se">\</span>
-v /tmp:/tmp <span class="se">\</span>
-v /dev:/dev <span class="se">\</span>
-v /sys:/sys <span class="se">\</span>
-v /etc/vart.conf:/etc/vart.conf <span class="se">\</span>
-v /lib/firmware/xilinx:/lib/firmware/xilinx <span class="se">\</span>
-v /run:/run <span class="se">\</span>
-it xilinx/smartcam:2022.1 bash
</pre></div>
</div>
<p>First try running gstreamer with the accelerator by-passed to make sure things work fine, you should expect to see the monitor displaying what it captured in MIPI. This command assumes that we use a MIPI camera mapped to media0, and that monitor supports 1920x1080p:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gst-launch-1.0 mediasrcbin media-device<span class="o">=</span>/dev/media0 v4l2src0::io-mode<span class="o">=</span>mmap ! <span class="s2">&quot;video/x-raw, width=1920, height=1080, format=NV12, framerate=30/1&quot;</span> ! perf ! kmssink plane-id<span class="o">=</span><span class="m">39</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span> -v
</pre></div>
</div>
<p>This confirms that the monitor is working as expected.</p>
<p>Next, try running using filter2d in the PL. Copy the software to the following folders:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir /usr/lib/vvas/
cp /tmp/libvvas_xfilter2d_pl.so /usr/lib/vvas/

gst-launch-1.0 filesrc <span class="nv">location</span><span class="o">=</span><span class="s2">&quot;/tmp/bbb_sunflower_1080p_30fps_normal.mp4&quot;</span> ! decodebin ! videoconvert ! video/x-raw, <span class="nv">width</span><span class="o">=</span><span class="m">1920</span>, <span class="nv">height</span><span class="o">=</span><span class="m">1080</span>, <span class="nv">format</span><span class="o">=</span>YUY2, <span class="nv">framerate</span><span class="o">=</span><span class="m">30</span>/1 ! vvas_xfilter kernels-config<span class="o">=</span>/tmp/kernel_xfilter2d_pl.json dynamic-config<span class="o">=</span><span class="s1">&#39;{ &quot;filter_preset&quot; : &quot;edge&quot; }&#39;</span> ! perf ! kmssink driver-name<span class="o">=</span>xlnx plane-id<span class="o">=</span><span class="m">39</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span> <span class="nv">sync</span><span class="o">=</span><span class="nb">false</span> -v
</pre></div>
</div>
<p>You should be able to see the video being displayed with filter_preset set to “edge”. You can try other presets as well. The list can be found <a class="reference external" href="https://github.com/Xilinx/vck190-base-trd/blob/2022.1/overlays/filter2d/apps/filter2d-notebooks/filter2d-notebooks/vvas-accel-sw-libs/vvas_xfilter2d_pl/src/vvas_xfilter2d.h#L50">here</a>. If there are spaces in preset, replease it with underscore. For an example, <code class="docutils literal notranslate"><span class="pre">horizontal</span> <span class="pre">edge</span></code> should be <code class="docutils literal notranslate"><span class="pre">horizontal_edge</span></code> in above command.  The framerate being displayed will be slow - we had to do format convertation in software, therefore each frame will take time.</p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this heading">¶</a></h2>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License.</p>
<p>You may obtain a copy of the License at
<a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p align="center">Copyright&copy; 2021 Xilinx</p></div>
</div>


           </div>
          </div>
          
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vivado_accel_example.html" class="btn btn-neutral float-left" title="Vivado Accelerator Flow Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vitis_platform_flow_smartcam_raspi_example.html" class="btn btn-neutral float-right" title="Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2023, Advanced Micro Devices, Inc.
      <span class="lastupdated">Last updated on September 13, 2023.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>