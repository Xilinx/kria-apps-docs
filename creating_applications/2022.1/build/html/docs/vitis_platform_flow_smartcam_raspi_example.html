<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
<!-- End Google Tag Manager -->
  <title>Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform &mdash; Kria™ SOM 2022.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Example - Creating a Platform for a Custom Carrier Card" href="custom_cc_flow_example.html" />
    <link rel="prev" title="Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application" href="vitis_accel_flow_smartcam_filter2d_example.html" /> 
</head>

<body class="wy-body-for-nav">

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
<!-- End Google Tag Manager --> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../index.html" class="icon icon-home"> Kria™ SOM
            <img src="../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SOM</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/">Landing Page</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/Kria_doc_map/map.htm">Kria Adventure Map</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/creating_applications.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/ubuntu_support.html">Ubuntu Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/bootfw.html">Boot Firmware</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/openamp.html">OpenAMP</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/dfx.html">Dynamic Function eXchange</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/ipmi_eeprom.html">IPMI EEPROM Design Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/yocto.html">Yocto Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/xen.html">XEN Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kd240-docs.html">Kria KD240</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260-docs.html">Kria KV260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kr260-docs.html">Kria KR260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/KRS/">Kria Robotics Stack</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flows</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Development Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="vitis_accel_flow.html">Vitis Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vitis_platform_flow.html">Vitis Platform Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vivado_accel_flow.html">Vivado Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_cc_flow.html">Custom Carrier Card Flow</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vivado_accel_example.html">Vivado Accelerator Flow Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="vitis_accel_flow_smartcam_filter2d_example.html">Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites-and-hardware-setup">Prerequisites and hardware setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generating-platform">Generating platform</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-platform">Obtaining Platform</a></li>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-isp-single-ip">Obtaining isp_single IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#importing-raspberry-pi-pipeline">Importing Raspberry Pi Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-block-design">Updating Block Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constraint-file">Constraint file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#address-map">Address map</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lower-clock-rate">Lower clock rate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#platform-setup">Platform setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validate-design">Validate design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-wrapper">Generate wrapper</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-output-products">Generate output products</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-bitstream">Generate bitstream</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-dtsi-file">Creating dtsi file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#base-address">Base Address</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interrupt">Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpio">GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i2c">I2C</a></li>
<li class="toctree-l4"><a class="reference internal" href="#afi-ports">AFI ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitstream-file-name">Bitstream file name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clock-frequency">Clock Frequency</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-dtsi-to-dtbo">Compile .dtsi to .dtbo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#installing-drivers-on-ubuntu">Installing drivers on Ubuntu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-platform-on-target">Testing the platform on target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exporting-design">Exporting design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-accelerator">Adding Accelerator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-with-accelerator-on-target">Test with Accelerator on Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom_cc_flow_example.html">Example - Creating a Platform for a Custom Carrier Card</a></li>
<li class="toctree-l2"><a class="reference internal" href="dtsi_dtbo_generation_smartcam_example.html">Example - Generating DTSI and DTBO Overlay Files for Smartcam</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="baremetal.html">Bare-metal Flow Example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kria Vitis Acceleration Flow</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="kria_vitis_acceleration_flow/kria-vitis-acceleration.html">Kria Vitis Acceleration Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="target.html">On-target Utilities and Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootmodes.html">Setting Bootmodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="dtsi_dtbo_generation.html">Generating DTSI and DTBO Overlay Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="bitstream_management.html">Bitstream Management on Kria SOM</a></li>
<li class="toctree-l1"><a class="reference internal" href="AI_customization.html">AI Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="Generate_vivado_project_from_boardfile.html">Generate a Vivado Project from Board Files</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Releases</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/creating_applications/2021.1/build/html/index.html">2021.1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kria™ SOM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="examples.html">Examples</a> &raquo;</li>
      <li>Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/docs/vitis_platform_flow_smartcam_raspi_example.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="vitis-platform-flow-example-adding-raspberry-pi-camera-to-smartcam-s-platform">
<h1>Vitis Platform Flow Example - Adding Raspberry Pi Camera to SmartCam’s Platform<a class="headerlink" href="#vitis-platform-flow-example-adding-raspberry-pi-camera-to-smartcam-s-platform" title="Permalink to this heading">¶</a></h1>
<p>This example will take smartcam’s platform - kv260_ispMipiRx_vcu_DP, remove its MIPI ISP and audio IPs, and add Raspberry Pi support instead. Then we will add in the DPU accelerator overlay for smartcam application. Functionally, this will allow smartcam app to take image sensor input from Raspberry Pi Camera on J9 instead of the AP1305 sensors on J7.</p>
<p>The tutorial will first re-generate the platform with Raspberry Pi pipeline, creating its corresponding bitstream and device tree artifacts. We will then test those artifacts with Raspberry Pi Camera to display Raspberry Pi capture on the monitor without any accelerator functions. Then we will take the platform and add DPU accelerator, and re-test the firmware with accelerator function added in - the accelerator function will create a blue bounding box on faces detected.</p>
<p>This example is targeted for 22.1 release on Ubuntu 22.04 for KV260.</p>
<div class="section" id="prerequisites-and-hardware-setup">
<h2>Prerequisites and hardware setup<a class="headerlink" href="#prerequisites-and-hardware-setup" title="Permalink to this heading">¶</a></h2>
<p>You must have gone through tutorial in running <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/smartcamera_landing.html">smartcam</a> on KV260 Ubuntu 22.04, based on tool version 2022.1, so that you understand how to program SD card, and basics of running an application on KV260. The example also uses Smartcam docker container to provide drivers needed.</p>
<p>The hardware setup is similar to that of <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/docs/app_deployment.html#application-specific-hardware-setup">smartcam</a>, except you will not need the IAS sensor in J7, but a Raspberry Pi Camera on J9 instead. This tutorial has been tested with the <a class="reference external" href="https://community.element14.com/products/raspberry-pi/w/documents/1502/new-pi-camera-and-pi-camera-noir-v2">Rasberry Pi Camera V2 from element14</a>.</p>
<p>This example is based on 2022.1 releases, so be sure to use 22.1 for tools, bsps, repositories, etc.</p>
</div>
<div class="section" id="generating-platform">
<h2>Generating platform<a class="headerlink" href="#generating-platform" title="Permalink to this heading">¶</a></h2>
<div class="section" id="obtaining-platform">
<h3>Obtaining Platform<a class="headerlink" href="#obtaining-platform" title="Permalink to this heading">¶</a></h3>
<p>Since we are altering smartcam’s platform kv260_ispMipiRx_vcu_DP, we will first need to get the platform. Detailed tutorial is at <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/build_vitis_platform.html">Creating Vitis Platform</a>. Here are the specific commands to use to generate the platform:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone --recursive --branch xlnx_rel_v2022.1 https://github.com/Xilinx/kria-vitis-platforms.git
<span class="nb">cd</span> kria-vitis-platforms/kv260/
</pre></div>
</div>
<p>We will refer to the above directory as <code class="docutils literal notranslate"><span class="pre">$kv260-vitis</span></code> in this page.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make platform <span class="nv">PFM</span><span class="o">=</span>kv260_ispMipiRx_vcu_DP
<span class="nb">cd</span> <span class="nv">$kv260</span>-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/project/
</pre></div>
</div>
<p>The vivado project will be at <code class="docutils literal notranslate"><span class="pre">$kv260-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/project/kv260_ispMipiRx_vcu_DP.xpr</span></code></p>
<p>Open the .xpr project in Vivado.</p>
</div>
<div class="section" id="obtaining-isp-single-ip">
<h3>Obtaining isp_single IP<a class="headerlink" href="#obtaining-isp-single-ip" title="Permalink to this heading">¶</a></h3>
<p>In this example, we use a Raspberry Pi pipeline that uses a ISP block. This is a custom IP that is not present in AMD IP catalog, so we will need to manually copy it to our project. This IP can be found in <code class="docutils literal notranslate"><span class="pre">$kv260-vitis/platforms/vivado/kv260_ispMipiRx_rpiMipiRx_DP/ip/isp_single_kv260/</span></code>, this is the platform for nlp_smartvision app that has support for Raspberry Pi.</p>
<p>Do the following to generate ip:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$kv260</span>-vitis/platforms/vivado/kv260_ispMipiRx_rpiMipiRx_DP/ip/isp_single_kv260/
make ip
</pre></div>
</div>
<p>This will generate a <code class="docutils literal notranslate"><span class="pre">isppipeline.prj/</span></code> folder - this is the ISP IP we will use in this project.</p>
<p>In Vivado project where you have kv260_ispMipiRx_vcu_DP.xpr opened, click on Project Manager -&gt; IP Catalog, and note the user Repository. This is where you should copy the ip <code class="docutils literal notranslate"><span class="pre">isp_single_kv260/</span></code> to. It should be in <code class="docutils literal notranslate"><span class="pre">$kv260-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/ip/</span></code></p>
<p>Copy the single_isp IP over:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$kv260</span>-vitis/
cp platforms/vivado/kv260_ispMipiRx_rpiMipiRx_DP/ip/isp_single_kv260/ platforms/vivado/kv260_ispMipiRx_vcu_DP/ip/ -rf
</pre></div>
</div>
<p>Then refresh the repo:
<img alt="refresh repo" src="../_images/1refresh_repo.PNG" /></p>
</div>
<div class="section" id="importing-raspberry-pi-pipeline">
<h3>Importing Raspberry Pi Pipeline<a class="headerlink" href="#importing-raspberry-pi-pipeline" title="Permalink to this heading">¶</a></h3>
<p>Next, we will need to import the Raspberry Pi pipeline that will replace the original ISP pipeline in kv260_ispMipiRx_vcu_DP.</p>
<p>Download source <a class="reference external" href="./example_src/raspi_example/capture_pipeline_raspi.tcl">capture_pipeline_raspi.tcl</a>, and source it in the tcl console of Vivado.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> capture_pipeline_raspi.tcl
</pre></div>
</div>
<p>Next, click on Flow Navigator -&gt; IP Integrator -&gt; Open Block Design, and then in tcl Console, type in the following to instantiate the subblock of ISP pipeline for Raspberry Pi:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>create_hier_cell_capture_pipeline_raspi ./ raspi_pipeline
</pre></div>
</div>
<p>This will create a new, unconnected block of Raspberry Pi ISP pipeline in the existing block design. You can double click on the block to see the component of this subblock. Note that you can find pin assignment for Raspberry Pi in mipi_csi2_rx_subsyst_0 by double clicking on the IP and going to Pin Assignment tab.</p>
<div class="section" id="optional-generating-capture-pipeline-raspi-tcl">
<h4>Optional - generating capture_pipeline_raspi.tcl<a class="headerlink" href="#optional-generating-capture-pipeline-raspi-tcl" title="Permalink to this heading">¶</a></h4>
<p>Below steps are how to generate capture_pipeline_raspi.tcl in the platform used for Raspberry Pi-supported NLP application. This is not needed as we have provided the file here, but we provide instruction to show you how it was imported from one project to another.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$kv260</span>-vitis
make platform <span class="nv">PFM</span><span class="o">=</span>kv260_ispMipiRx_rpiMipiRx_DP
</pre></div>
</div>
<p>open <code class="docutils literal notranslate"><span class="pre">platforms/vivado/kv260_ispMipiRx_rpiMipiRx_DP/project/kv260_ispMipiRx_rpiMipiRx_DP.xpr</span></code> in Vivado. Click IP Integrator -&gt; Open Block Design.</p>
<p>Double click “capture_pipeline_raspi, then double click mipi_csi2_rx_subsyst_0, select “Shared Logic” tab and change to “Include Shared Logic in Core” and click “okay”. This will remove pll_lock_in and clkoutphy_in pins. remove the unconnected pins from capture_pipeline_raspi hirerarcy’s pin list as well.</p>
<p>in vivado Tcl Console:</p>
<p><code class="docutils literal notranslate"><span class="pre">write_bd_tcl</span> <span class="pre">-hier_blks</span> <span class="pre">[get_bd_cells</span> <span class="pre">capture_pipeline_raspi]</span> <span class="pre">capture_pipeline_raspi.tcl</span></code></p>
<p>This generates <code class="docutils literal notranslate"><span class="pre">capture_pipeline_raspi.tcl</span></code></p>
</div>
</div>
<div class="section" id="updating-block-design">
<h3>Updating Block Design<a class="headerlink" href="#updating-block-design" title="Permalink to this heading">¶</a></h3>
<p>Next, we will want to replace the capture_pipeline with this raspi_pipeline. Most of the signals can be replaced one to one - if its the same signal between capture_pipeline and raspi_pipeline, disconnect the signal/bus on capture_pipeline and connect other ip/interface to to raspi_pipeline instead. At the end, click on “capture pipeline” and press “delete” to remove it. You should have most of the raspi_pipeline connected by now:
<img alt="disconnect capture_pipeline" src="../_images/2disconnectap1302.PNG" /></p>
<p>You will notice that s_axi_CTRL and s_axi_ctrl_vpss are still not connected. We will need to create connections for them. Find  axi_ic_ctrl_300 - it currently only has 1 M00_AXI port connected to raspi_pipeline/s_axi_ctrl_frm_buf. Double click on  axi_ic_ctrl_300, and change Number of Master Interfaces from 1 to 3:</p>
<p><img alt="connect raspi_pipeline" src="../_images/3connect_raspi_axi.PNG" /></p>
<p>Now, connect the ACLK, ARRESETN signals on axi_ic_ctrl_300, and connect the M01_AXI and M02_AXI to the two s_axi ports on raspi_pipeline thats still unconnected.</p>
<p><img alt="connect raspi_pipeline" src="../_images/4connect_raspi_axi2.PNG" /></p>
<p>Next, we need to free up an interrupt port because Raspi_pipeline has more interrupts than the “capture_pipeline” we deleted. We will not need the audio path in this experiment, so we can remove them. In block design, we can find “Audio_ss_0” block to delete them. Next, update “axi_ic_audio_mcu” to have 1 single slave port instead of 3; this interconnect is still needed because of address width difference between m_axi_vcu_mcu port of “axi_ic_audio_mcu” and s_axi_lpd port of “ps_0”. This also frees up 3 ports on axi_ic_ctrl_100 - double click that and change from 6 master ports to 3 master ports.</p>
<p>Next, PS_0/S_AXI_HP0_FPD is currently 128 bit wide, but the new connection raspi_pipeline/m_axi_mm_video is only 64 bit. double click on PS_0, choose PS-PL  Configuration -&gt; PS-PL Interfaces -&gt; Slave Interfaces -&gt; AXI HP -&gt; AXI HP0 FPD -&gt; change AXI HP0 FPD Data Width from 128 to 64.</p>
<p>It should look like below, click OK:</p>
<p><img alt="connect raspi_pipeline" src="../_images/7HP64bit.PNG" /></p>
<p>Next, connect the interrupts:
<img alt="connect raspi_pipeline" src="../_images/5connect_raspi_interrupt.PNG" /></p>
<p>Raspberry Pi requires us to enable HDA09 via the F11 pin. Right Click -&gt; Add IP “Constant” with “Const Val” = 1, right click -&gt; create port with “Port name” = raspi_enable, Direction = Output, Type = other. Connect them.  This ensures that we enable HDA09.</p>
<p><img alt="connect raspi_pipeline" src="../_images/6enableHDA09.PNG" /></p>
</div>
<div class="section" id="constraint-file">
<h3>Constraint file<a class="headerlink" href="#constraint-file" title="Permalink to this heading">¶</a></h3>
<p>We can re-use the constraints for MIPI phy. Raspberry Pi requires us to enable HDA09 via the F11 pin.  To add raspi_enable constraint, add the following to <code class="docutils literal notranslate"><span class="pre">prj/prj.srcs/constrs_1/imports/xdc/pin.xdc</span></code> :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#Raspi Enable HDA09</span>
set_property PACKAGE_PIN F11 <span class="o">[</span>get_ports <span class="o">{</span>raspi_enable<span class="o">}]</span>
set_property IOSTANDARD LVCMOS33 <span class="o">[</span>get_ports <span class="o">{</span>raspi_enable<span class="o">}]</span>
set_property SLEW SLOW <span class="o">[</span>get_ports <span class="o">{</span>raspi_enable<span class="o">}]</span>
set_property DRIVE <span class="m">4</span> <span class="o">[</span>get_ports <span class="o">{</span>raspi_enable<span class="o">}]</span>
</pre></div>
</div>
</div>
<div class="section" id="address-map">
<h3>Address map<a class="headerlink" href="#address-map" title="Permalink to this heading">¶</a></h3>
<p>Go to Address Editor tab and modify the address of the ones in green boxes of the snapshot below. you will want to first select all the unasigned address, right click, and click on assign. Then go back and modify their address and range to match below. (you can also leave the PS_0/raspi_pipeline* address at default, just matching the range, but you will then need to update .dtsi to match)</p>
<p><img alt="connect raspi_pipeline" src="../_images/8address.PNG" /></p>
</div>
<div class="section" id="lower-clock-rate">
<h3>Lower clock rate<a class="headerlink" href="#lower-clock-rate" title="Permalink to this heading">¶</a></h3>
<p>Double click clk_wiz_0 and change clk_300M to clkv_200M and update output frequency. The Raspberry Pi IP will not meet timing at 300mhz.</p>
<p><img alt="update clk" src="../_images/8_5_updateclk.PNG" /></p>
<p>Now go to Platform Setup tab, click on “Clock” and enable the new clkv_200M and set it as default clock:
<img alt="update clk" src="../_images/8_5_updateclk2.PNG" /></p>
</div>
<div class="section" id="platform-setup">
<h3>Platform setup<a class="headerlink" href="#platform-setup" title="Permalink to this heading">¶</a></h3>
<p>Go to Platform Setup tab - no changes are needed, but note that we are keeping the same ports for accelerator insertion in Vitis.</p>
</div>
<div class="section" id="validate-design">
<h3>Validate design<a class="headerlink" href="#validate-design" title="Permalink to this heading">¶</a></h3>
<p>Tools (top tool bar) -&gt; Validate Design - click “No” when it asks if you want to auto assign unassigned address segment.</p>
</div>
<div class="section" id="generate-wrapper">
<h3>Generate wrapper<a class="headerlink" href="#generate-wrapper" title="Permalink to this heading">¶</a></h3>
<p>We need to re-generate the wrapper because we have added a raspi_enable signal.</p>
<p>Block Design -&gt; sources -&gt; Design Sources -&gt; right click on kv260_ispMipiRx_vcu_DP_wrapper and select “Remove File from Project”:</p>
<p><img alt="wrapper" src="../_images/9removewrapper.PNG" /></p>
<p>in pop-up select “Ignore and continue with invalid top module”</p>
<p>Block Design -&gt; sources -&gt; Design Sources -&gt; right click on kv260_ispMipiRx_vcu_DP and select “Generate HDL wrapper”:</p>
<p><img alt="wrapper" src="../_images/10createwrapper.PNG" /></p>
<p>In the pop-up, select “Let Vivado manage wrapper and auto-update” and press OK.</p>
<p>double click the kv260_ispMipiRx_vcu_DP_wrapper file and you should see raspi_enable as one of the outputs in the wrapper.</p>
</div>
<div class="section" id="generate-output-products">
<h3>Generate output products<a class="headerlink" href="#generate-output-products" title="Permalink to this heading">¶</a></h3>
<p>Block Design -&gt; sources -&gt; Design Sources -&gt; right click on kv260_ispMipiRx_vcu_DP_i and select “Reset Output Products”. Then</p>
<p>Block Design -&gt; sources -&gt; Design Sources -&gt; right click on kv260_ispMipiRx_vcu_DP_i and select “Generate Output Products”, and choose “out of context per IP” and click Generate:</p>
<p><img alt="wrapper" src="../_images/11createoutput.PNG" /></p>
</div>
<div class="section" id="generate-bitstream">
<h3>Generate bitstream<a class="headerlink" href="#generate-bitstream" title="Permalink to this heading">¶</a></h3>
<p>Now we are ready to generate bitstream. To generate bitstream, click on Program and Debug -&gt; Generate Bitstream. This process will take some time.</p>
<p>After .bit file has been generated, we need to convert it to .bit.bin file, a format that xmutil is expecting:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$kv260</span>-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/project/kv260_ispMipiRx_vcu_DP.runs/impl_1/
<span class="nb">echo</span> <span class="s1">&#39;all:{kv260_ispMipiRx_vcu_DP_wrapper.bit}&#39;</span>&gt;bootgen.bif
bootgen -w -arch zynqmp -process_bitstream bin -image bootgen.bif
mv kv260_ispMipiRx_vcu_DP_wrapper.bit.bin kv260-smartcam-raspi.bit.bin
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-dtsi-file">
<h2>Creating dtsi file<a class="headerlink" href="#creating-dtsi-file" title="Permalink to this heading">¶</a></h2>
<p>We will base our .dtsi file from the <a class="reference external" href="https://github.com/Xilinx/kria-apps-firmware/blob/xlnx_rel_v2022.1/boards/kv260/smartcam/kv260-smartcam.dtsi">smartcam .dtsi file</a>. We will need to remove the isp and audio devices, as well as ap1302 on i2c port 0.</p>
<p>In their stead, we will need to add the imx devices and their associated support functions. The resulting dtsi file can be found in <a class="reference external" href="./example_src/raspi_example/kv260-smartcam-raspi_2022.1.dtsi">kv260-smartcam-raspi.dtsi</a>. There are a few things to correlate to the PL design:</p>
<div class="section" id="base-address">
<h3>Base Address<a class="headerlink" href="#base-address" title="Permalink to this heading">¶</a></h3>
<p>Each device in the dtsi needs to have the correct address corresponding to what we had set in “Address Map” section. The provided .dtsi corresponds to the screenshot - make necessary changes if your address map is different.</p>
<ul class="simple">
<li><p>imx_isp0 in dtsi correspond to ISPPipeline_accel_0</p></li>
<li><p>imx_csiss_1 in dtsi corresponds to mipi_csi2_rx_subsyst_0</p></li>
<li><p>imx_scalar_1 in dtsi corresponds to v_proc_ss_0</p></li>
<li><p>imx_fb_wr_csi corresponds to v_frmbuf_wr_0</p></li>
</ul>
</div>
<div class="section" id="interrupt">
<h3>Interrupt<a class="headerlink" href="#interrupt" title="Permalink to this heading">¶</a></h3>
<p>Please note that the interrupt numbers 104 through 111 is corresponding to <code class="docutils literal notranslate"><span class="pre">pl_ps_irq1[0]</span></code> through <code class="docutils literal notranslate"><span class="pre">pl_ps_irq1[7]</span></code>. Thus, make sure that:</p>
<ul class="simple">
<li><p>imx_csiss_1 has interrupt 104, if csirxss_csi_irq is connected to In0 of xlconcat_0_0, which feeds to pl_ps_irq1[0]</p></li>
<li><p>imx_isp0 has interrupt 105, if dem_irq is connected to In1 of xlconcat_0_0, which feeds to pl_ps_irq1[1]</p></li>
<li><p>imx_fb_wr_csi has interrupt 108, if dem_irq is connected to In4 of xlconcat_0_0, which feeds to pl_ps_irq1[4]</p></li>
</ul>
</div>
<div class="section" id="gpio">
<h3>GPIO<a class="headerlink" href="#gpio" title="Permalink to this heading">¶</a></h3>
<p>This should not require any changes, but the <code class="docutils literal notranslate"><span class="pre">reset-gpio[86:82]</span></code> in dtsi is corresponding to <code class="docutils literal notranslate"><span class="pre">PS_0/emio_gpio_o[8:4]</span></code>, you can see that the emio_gpio_o ius routed into raspi_pipeline to some rstn signals, and their position correspond to the gpio settings for each device in the .dtsi file.</p>
</div>
<div class="section" id="i2c">
<h3>I2C<a class="headerlink" href="#i2c" title="Permalink to this heading">¶</a></h3>
<p>On the KV260 carrier card, Raspberry Pi is on I2c port 2, so imx219 is on i2x&#64;2 in the dtsi file.</p>
</div>
<div class="section" id="afi-ports">
<h3>AFI ports<a class="headerlink" href="#afi-ports" title="Permalink to this heading">¶</a></h3>
<p>Lastly, we have changed the S_AXI_HP0_FPD port from 128 bit to 62 bit, so we need to set the AFI device in dtsi, config 4, 5, to 1 to indicate 64 bits (0 = 128 bit, 1 = 64 bit, 2 = 32 bit):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>config-afi = &lt;0 0&gt;, &lt;1 0&gt;, &lt;2 0&gt;, &lt;3 0&gt;, &lt;4 1&gt;, &lt;5 1&gt;, &lt;6 0&gt;, &lt;7 0&gt;, &lt;8 0&gt;, &lt;9 0&gt;, &lt;10 0&gt;, &lt;11 0&gt;, &lt;12 0&gt;, &lt;13 0&gt;, &lt;14 0x0&gt;, &lt;15 0x000&gt;;
</pre></div>
</div>
</div>
<div class="section" id="bitstream-file-name">
<h3>Bitstream file name<a class="headerlink" href="#bitstream-file-name" title="Permalink to this heading">¶</a></h3>
<p>change <code class="docutils literal notranslate"><span class="pre">firmware-name</span></code> to its corresponding .bit.bin file name. This part is optional - the reference is not being used by dfx-mgr.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>firmware-name = &quot;kv260-smartcam-raspi.bit.bin&quot;;
</pre></div>
</div>
</div>
<div class="section" id="clock-frequency">
<h3>Clock Frequency<a class="headerlink" href="#clock-frequency" title="Permalink to this heading">¶</a></h3>
<p>Since we changed one of the clocks from 300mhz to 200mhz, we need to change the corresponding clocks (misc_clk_2) in dtsi to 200mhz:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>misc_clk_2: misc_clk_2 {
        #clock-cells = &lt;0x0&gt;;
        clock-frequency = &lt;199998000&gt;;
        compatible = &quot;fixed-clock&quot;;
};
</pre></div>
</div>
</div>
<div class="section" id="compile-dtsi-to-dtbo">
<h3>Compile .dtsi to .dtbo<a class="headerlink" href="#compile-dtsi-to-dtbo" title="Permalink to this heading">¶</a></h3>
<p>Your .dtsi file should look like <a class="reference external" href="./example_src/raspi_example/kv260-smartcam-raspi_2022.1.dtsi">this</a> after you are done.</p>
<p>Now compile the .dtsi file into .dtbo binary:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dtc -@ -O dtb -o kv260-raspi.dtbo kv260-raspi.dtsi
</pre></div>
</div>
<p>There will be a lot of warning messages, it is okay to ignore them. You should see a <code class="docutils literal notranslate"><span class="pre">kv260-smartcam-raspi.dtbo</span></code> in the folder.</p>
</div>
</div>
<div class="section" id="installing-drivers-on-ubuntu">
<h2>Installing drivers on Ubuntu<a class="headerlink" href="#installing-drivers-on-ubuntu" title="Permalink to this heading">¶</a></h2>
<p>This step assume that you have installed smartcam and are able to run smartcam application through docker container on Ubuntu. if not, follow the <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/kv260/2022.1/build/html/docs/smartcamera/smartcamera_landing.html">smartcam app deployment</a> instructions in Ubuntu 22.1 smartcam app deployment page to install smartcam.</p>
</div>
<div class="section" id="testing-the-platform-on-target">
<h2>Testing the platform on target<a class="headerlink" href="#testing-the-platform-on-target" title="Permalink to this heading">¶</a></h2>
<p>Now we want to test the platform generated to make sure Raspberry Pi pipeline is working. Note that we have not yet addedd in the DPU accelerator, so we wont be able to test the Raspberry Pi with smartcam application itself until later.</p>
<p>First, scp the kv260-raspi.dtbo kv260-raspi.bit.bin over to target or copy them to SD card and finding them in <code class="docutils literal notranslate"><span class="pre">/boot/firmware/</span></code>, and we can re-use the shell.json in /lib/firmware/xilinx/kv260-smartcam/shell.json:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo mkdir /lib/firmware/xilinx/kv260-raspi
sudo mv kv260-raspi.dtbo kv260-raspi.bit.bin shell.json /lib/firmware/xilinx/kv260-raspi
sudo xmutil listapps
sudo xmutil unloadapp
sudo xmutil loadapp kv260-raspi
sudo xmutil desktop_disable
</pre></div>
</div>
<p>If the hardware and the device tree has been created correctly, you should be able to see Raspberry Pi in /dev/media0:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>root@kria:~# media-ctl -d /dev/media0 -p
Media controller API version <span class="m">5</span>.15.39

Media device information
------------------------
driver          xilinx-video
model           Xilinx Video Composite Device
serial
bus info
hw revision     0x0
driver version  <span class="m">5</span>.15.39

Device topology
- entity <span class="m">1</span>: imx_vcap_csi output <span class="m">0</span> <span class="o">(</span><span class="m">1</span> pad, <span class="m">1</span> link<span class="o">)</span>
            <span class="nb">type</span> Node subtype V4L flags <span class="m">0</span>
            device node name /dev/video0
        pad0: Sink
                &lt;- <span class="s2">&quot;b0040000.scaler&quot;</span>:1 <span class="o">[</span>ENABLED<span class="o">]</span>

- entity <span class="m">5</span>: b0040000.scaler <span class="o">(</span><span class="m">2</span> pads, <span class="m">2</span> links<span class="o">)</span>
            <span class="nb">type</span> V4L2 subdev subtype Unknown flags <span class="m">0</span>
            device node name /dev/v4l-subdev0
        pad0: Sink
                <span class="o">[</span>fmt:RBG888_1X24/1920x1080 field:none colorspace:srgb<span class="o">]</span>
                &lt;- <span class="s2">&quot;b0000000.isp_accel&quot;</span>:1 <span class="o">[</span>ENABLED<span class="o">]</span>
        pad1: Source
                <span class="o">[</span>fmt:VYYUYY8_1X24/1920x1080 field:none colorspace:srgb<span class="o">]</span>
                -&gt; <span class="s2">&quot;imx_vcap_csi output 0&quot;</span>:0 <span class="o">[</span>ENABLED<span class="o">]</span>

- entity <span class="m">8</span>: imx219 <span class="m">6</span>-0010 <span class="o">(</span><span class="m">1</span> pad, <span class="m">1</span> link<span class="o">)</span>
            <span class="nb">type</span> V4L2 subdev subtype Sensor flags <span class="m">0</span>
            device node name /dev/v4l-subdev1
        pad0: Source
                <span class="o">[</span>fmt:SRGGB10_1X10/1920x1080 field:none colorspace:srgb xfer:srgb ycbcr:601 quantization:full-range
                 crop.bounds:<span class="o">(</span><span class="m">8</span>,8<span class="o">)</span>/3280x2464
                 crop:<span class="o">(</span><span class="m">688</span>,700<span class="o">)</span>/1920x1080<span class="o">]</span>
                -&gt; <span class="s2">&quot;80002000.csiss&quot;</span>:0 <span class="o">[</span>ENABLED<span class="o">]</span>

- entity <span class="m">10</span>: <span class="m">80002000</span>.csiss <span class="o">(</span><span class="m">2</span> pads, <span class="m">2</span> links<span class="o">)</span>
             <span class="nb">type</span> V4L2 subdev subtype Unknown flags <span class="m">0</span>
             device node name /dev/v4l-subdev2
        pad0: Sink
                <span class="o">[</span>fmt:SRGGB10_1X10/1920x1080 field:none colorspace:srgb xfer:srgb ycbcr:601 quantization:full-range<span class="o">]</span>
                &lt;- <span class="s2">&quot;imx219 6-0010&quot;</span>:0 <span class="o">[</span>ENABLED<span class="o">]</span>
        pad1: Source
                <span class="o">[</span>fmt:SRGGB10_1X10/1920x1080 field:none colorspace:srgb xfer:srgb ycbcr:601 quantization:full-range<span class="o">]</span>
                -&gt; <span class="s2">&quot;b0000000.isp_accel&quot;</span>:0 <span class="o">[</span>ENABLED<span class="o">]</span>

- entity <span class="m">13</span>: b0000000.isp_accel <span class="o">(</span><span class="m">2</span> pads, <span class="m">2</span> links<span class="o">)</span>
             <span class="nb">type</span> V4L2 subdev subtype Unknown flags <span class="m">0</span>
             device node name /dev/v4l-subdev3
        pad0: Sink
                <span class="o">[</span>fmt:SRGGB10_1X10/1920x1080 field:none colorspace:srgb xfer:srgb ycbcr:601 quantization:full-range<span class="o">]</span>
                &lt;- <span class="s2">&quot;80002000.csiss&quot;</span>:1 <span class="o">[</span>ENABLED<span class="o">]</span>
        pad1: Source
                <span class="o">[</span>fmt:RBG888_1X24/1920x1080 field:none colorspace:srgb<span class="o">]</span>
                -&gt; <span class="s2">&quot;b0040000.scaler&quot;</span>:0 <span class="o">[</span>ENABLED<span class="o">]</span>
</pre></div>
</div>
<p>Once we confirm that Raspberry Pi has been connected correctly, start the smartcam docker container so that we have the necessary dependencies for the next command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;DISPLAY&quot;</span> <span class="se">\</span>
-h <span class="s2">&quot;xlnx-docker&quot;</span> <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;XDG_SESSION_TYPE&quot;</span> <span class="se">\</span>
--net<span class="o">=</span>host <span class="se">\</span>
--privileged <span class="se">\</span>
--volume<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.Xauthority:/root/.Xauthority:rw&quot;</span> <span class="se">\</span>
-v /tmp:/tmp <span class="se">\</span>
-v /dev:/dev <span class="se">\</span>
-v /sys:/sys <span class="se">\</span>
-v /etc/vart.conf:/etc/vart.conf <span class="se">\</span>
-v /lib/firmware/xilinx:/lib/firmware/xilinx <span class="se">\</span>
-v /run:/run <span class="se">\</span>
-it xilinx/smartcam:2022.1 bash
</pre></div>
</div>
<p>In the docker container, now we can use the gstreamer commands below to display Raspberry Pi sensor information onto as 1080p monitor:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gst-launch-1.0 mediasrcbin media-device<span class="o">=</span>/dev/media0 v4l2src0::io-mode<span class="o">=</span>mmap ! <span class="s2">&quot;video/x-raw, width=1920, height=1080, format=NV12, framerate=30/1&quot;</span> ! kmssink plane-id<span class="o">=</span><span class="m">39</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span> -v
</pre></div>
</div>
</div>
<div class="section" id="exporting-design">
<h2>Exporting design<a class="headerlink" href="#exporting-design" title="Permalink to this heading">¶</a></h2>
<p>Now that we verified that the Raspberry Pi pipeline is working, you should export the block design in Vivado tcl:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>write_bd_tcl config_bd.tcl
</pre></div>
</div>
<p>You can see a working version of this block design <a class="reference external" href="./example_src/raspi_example/config_bd.tcl">here</a></p>
<p>A working version of the constraint is <a class="reference external" href="./example_src/raspi_example/pin.xdc">here</a>.</p>
</div>
<div class="section" id="adding-accelerator">
<h2>Adding Accelerator<a class="headerlink" href="#adding-accelerator" title="Permalink to this heading">¶</a></h2>
<p>In overlays/examples/smartcam/prj_conf/prj_config_1dpu, update clk since we had changed the 300mhz clock to 200mhz.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>freqHz=200000000:DPUCZDX8G_1.aclk
freqHz=400000000:DPUCZDX8G_1.ap_clk_2
freqHz=200000000:pp_pipeline_accel_1.ap_clk
</pre></div>
</div>
<p>Ensure that $kv260-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/ip/ has isppipeline.prj/ from previous step. This is necessary if you had jumped in from the provided block design and pin constraints.</p>
<p>Copy the block design (config_bd.tcl), pin constraint(pin.xdc), and ip into smartcam’s overlay area, note that they were generated in previous step.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cp  <span class="nv">$kv260</span>-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/project/kv260_ispMipiRx_vcu_DP.srcs/constrs_1/imports/xdc/pin.xdc <span class="nv">$kv260</span>-vitis/platforms/vivado/kv260_ispMipiRx_vcu_DP/xdc/pin.xdc
cp config_bd.tcl  platforms/vivado/kv260_ispMipiRx_vcu_DP/scripts/config_bd.tcl 
</pre></div>
</div>
<p>Now in $kv260-vitis, do a make clean so that the scripts would regenerate platform with the updated artifacts when we call <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">overlay</span> <span class="pre">OVERLAY=smartcam</span></code> in the next step</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make clean
</pre></div>
</div>
<p>Now we can run the makefile that was provided for smartcam to put DPU overlay into this platform:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make overlay <span class="nv">OVERLAY</span><span class="o">=</span>smartcam
</pre></div>
</div>
<p>After the makefile completes, you should find:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$working_dir</span>/overlays/examples/smartcam/binary_container_1/link/int/system.bit   
<span class="nv">$working_dir</span>/overlays/examples/smartcam/binary_container_1/dpu.xclbin
</pre></div>
</div>
<p>perform the following to convert system.bit to kv260-raspi-dpu.bit.bin:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$working_dir</span>/overlays/examples/smartcam/binary_container_1/link/int/
<span class="nb">echo</span> <span class="s1">&#39;all:{system.bit}&#39;</span> &gt; bootgen.bif
bootgen -w -arch zynqmp -process_bitstream bin -image bootgen.bif
mv system.bit.bin kv260-raspi-dpu.bit.bin
</pre></div>
</div>
</div>
<div class="section" id="test-with-accelerator-on-target">
<h2>Test with Accelerator on Target<a class="headerlink" href="#test-with-accelerator-on-target" title="Permalink to this heading">¶</a></h2>
<p>scp the kv260-raspi-dpu.bit.bin, kv260-raspi-dpu.dtbo (same file as kv260-raspi.dtbo - we can re-used the same .dtbo file across designs generated from the same platform in this flow), dpu.xclbin onto target. create a new app:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo mkdir /lib/firmware/xilinx/kv260-raspi-dpu
sudo mv  kv260-raspi-dpu.bit.bin /lib/firmware/xilinx/kv260-raspi-dpu/
sudo mv  kv260-raspi-dpu.dtbo /lib/firmware/xilinx/kv260-raspi-dpu/
sudo mv dpu.xclbin /lib/firmware/xilinx/kv260-raspi-dpu/kv260-raspi-dpu.xclbin
sudo cp /lib/firmware/xilinx/kv260-raspi/shell.json /lib/firmware/xilinx/kv260-raspi-dpu/
</pre></div>
</div>
<p>Next, find facedetect’s preprocess.json using <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">find</span> <span class="pre">/</span> <span class="pre">-iname</span> <span class="pre">preprocess.json</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">facedetect</span></code>, and then update the file found on target <code class="docutils literal notranslate"><span class="pre">/var/lib/docker/overlay2/&lt;id&gt;/diff/opt/xilinx/kv260-smartcam/share/vvas/facedetect/preprocess.json</span></code> to point to the correct xclbin <code class="docutils literal notranslate"><span class="pre">/lib/firmware/xilinx/kv260-raspi-dpu/kv260-raspi-dpu.xclbin</span></code>. We do this outside of docker environment because the docker container doesn’t have a text editor by default.
Alternatively, you can launch docker container, install vi using <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">vim</span></code>, and edit <code class="docutils literal notranslate"><span class="pre">/opt/xilinx/kv260-smartcam/share/vvas/facedetect/preprocess.json</span></code> from docker container. Note that you must loadapp before launch docker as shown below.</p>
<p>Execute the application with gst-launch, so that smart cam uses the Raspberry Pi pipeline on /dev/media0:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo xmutil listapps
sudo xmutil unloadapp
sudo xmutil loadapp kv260-raspi-dpu
docker run <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;DISPLAY&quot;</span> <span class="se">\</span>
-h <span class="s2">&quot;xlnx-docker&quot;</span> <span class="se">\</span>
--env<span class="o">=</span><span class="s2">&quot;XDG_SESSION_TYPE&quot;</span> <span class="se">\</span>
--net<span class="o">=</span>host <span class="se">\</span>
--privileged <span class="se">\</span>
--volume<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.Xauthority:/root/.Xauthority:rw&quot;</span> <span class="se">\</span>
-v /tmp:/tmp <span class="se">\</span>
-v /dev:/dev <span class="se">\</span>
-v /sys:/sys <span class="se">\</span>
-v /etc/vart.conf:/etc/vart.conf <span class="se">\</span>
-v /lib/firmware/xilinx:/lib/firmware/xilinx <span class="se">\</span>
-v /run:/run <span class="se">\</span>
-it xilinx/smartcam:latest bash

check <span class="k">if</span> above is <span class="nb">true</span> after release!!!!!!!!!!!!!!!!!!!!!!!!!!!! <span class="k">for</span> now use:
sudo docker run --env<span class="o">=</span><span class="s2">&quot;DISPLAY&quot;</span> -h <span class="s2">&quot;xlnx-docker&quot;</span> --env<span class="o">=</span><span class="s2">&quot;XDG_SESSION_TYPE&quot;</span> --net<span class="o">=</span>host --privileged --volume<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.Xauthority:/root/.Xauthority:rw&quot;</span> -v /tmp:/tmp -v /dev:/dev -v /sys:/sys -v /etc/vart.conf:/etc/vart.conf -v /lib/firmware/xilinx:/lib/firmware/xilinx -v /run:/run -it smartcam:latest bash
</pre></div>
</div>
<p>In docker container:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gst-launch-1.0 mediasrcbin <span class="nv">name</span><span class="o">=</span>videosrc media-device<span class="o">=</span>/dev/media0  v4l2src0::io-mode<span class="o">=</span>mmap v4l2src0::stride-align<span class="o">=</span><span class="m">256</span> !  video/x-raw, <span class="nv">width</span><span class="o">=</span><span class="m">1920</span>, <span class="nv">height</span><span class="o">=</span><span class="m">1080</span>, <span class="nv">format</span><span class="o">=</span>NV12, <span class="nv">framerate</span><span class="o">=</span><span class="m">30</span>/1  ! tee <span class="nv">name</span><span class="o">=</span>t ! queue ! vvas_xmultisrc <span class="nv">kconfig</span><span class="o">=</span><span class="s2">&quot;/opt/xilinx/kv260-smartcam/share/vvas/facedetect/preprocess.json&quot;</span> ! queue ! vvas_xfilter kernels-config<span class="o">=</span><span class="s2">&quot;/opt/xilinx/kv260-smartcam/share/vvas/facedetect/aiinference.json&quot;</span> ! ima.sink_master                     vvas_xmetaaffixer <span class="nv">name</span><span class="o">=</span>ima ima.src_master ! fakesink t. ! queue max-size-buffers<span class="o">=</span><span class="m">1</span> <span class="nv">leaky</span><span class="o">=</span><span class="m">2</span> ! ima.sink_slave_0 ima.src_slave_0 ! queue ! vvas_xfilter kernels-config<span class="o">=</span><span class="s2">&quot;/opt/xilinx/kv260-smartcam/share/vvas/facedetect/drawresult.json&quot;</span>          ! queue ! kmssink driver-name<span class="o">=</span>xlnx plane-id<span class="o">=</span><span class="m">39</span> <span class="nv">sync</span><span class="o">=</span><span class="nb">false</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Congratulations! You should be able to see Raspberry Pi capture on the display port monitor, with blue bounding box around faces detected. In case you do not and want to test with a known working set of firmware, you can find them [here](./example_src/raspi_example/smartcam-raspi_firmware_works/, be sure to update folder name or file names and commands to align with each other).</p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this heading">¶</a></h2>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License.</p>
<p>You may obtain a copy of the License at
<a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p class="sphinxhide" align="center">Copyright&copy; 2023 Advanced Micro Devices, Inc</p></div>
</div>


           </div>
          </div>
          
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vitis_accel_flow_smartcam_filter2d_example.html" class="btn btn-neutral float-left" title="Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="custom_cc_flow_example.html" class="btn btn-neutral float-right" title="Example - Creating a Platform for a Custom Carrier Card" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2024, Advanced Micro Devices, Inc.
      <span class="lastupdated">Last updated on February 01, 2024.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>