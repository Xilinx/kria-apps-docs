


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

	
		<!-- Google Tag Manager -->
	<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
	<!-- End Google Tag Manager -->
	
        <!-- Google Tag Manager -->
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
        <!-- End Google Tag Manager -->	

  
  
  
  

  
      <script type="text/javascript" src="../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../_static/js/Searchbox.min.js"></script>
    <script type="text/javascript" src="../_static/js/header-footer.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pro.min.css" media="all" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bare-metal Flow Example" href="baremetal.html" />
    <link rel="prev" title="Vitis Accelerator Flow Example - Adding VADD Accelerator using Vitis GUI" href="vitis_accel_vadd_example.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
 <div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">

    
    

    



<div class="xf-content-height">
    

<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
    
    <div class="header parbase aem-GridColumn aem-GridColumn--default--12"><noindex>
	<header data-component="header" class="site-header">
		<nav class="navbar navbar-default">
			<div class="container-fluid main-nav">
				<div class="row">
					<div class="navbar-column col-xs-4 col-sm-5">
						<ul class="nav navbar-nav hidden-xs">
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
								</li>
							</ul>
							
						<ul class="nav navbar-nav hidden-sm hidden-md hidden-lg">
							<li>
									<button data-target="#header-container-0" data-function="toggle">Solutions</button>
								</li>
							<li>
									<button data-target="#header-container-1" data-function="toggle">Products</button>
								</li>
							<li>
									<button data-target="#header-container-2" data-function="toggle">Company</button>
								</li>
							</ul>
							
						<div id="header-container-0" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-1" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-2" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							</div>
					<div class="logo-column col-xs-4 col-sm-2">
						<div class="logo">
							<a target="_blank" href="https://www.xilinx.com/">
								<img src="https://github.com/Xilinx/Image-Collateral/blob/main/xilinx-header-logo.svg?raw=true" title="Xilinx Inc"/>
							</a>
						</div>
					</div>

				</div>
			</div>
			</nav></header></noindex></div>
		
	
</div>

    
</div>
</div>

<div class="calloutBanner parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><div class="callout-banner">
    Xilinx is now a part of <a target="_blank" href="https://www.amd.com/en/corporate/xilinx-acquisition">AMD</a> |  <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Learn More</a>
</div>
</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Kria™ SOM
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">SOM</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/">Home</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pages.gitenterprise.xilinx.com/techdocs/SOM/kria_som_ubuntu_support/build/html/index.html">Ubuntu Support</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/index.html">Kria KV260</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/KRS/">KRS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Flows</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="vitis_accel_flow.html">Vitis Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vitis_platform_flow.html">Vitis Platform Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="vivado_accel_flow.html">Vivado Accelerator Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_cc_flow.html">Custom Carrier Card Flow</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vivado_accel_example.html">Vivado Accelerator Flow Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="vitis_accel_vadd_example.html">Vitis Accelerator Flow Example - Adding VADD Accelerator using Vitis GUI</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-platform">Obtaining Platform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#obtaining-filter2d">Obtaining filter2d</a></li>
<li class="toctree-l3"><a class="reference internal" href="#altering-application-overlay">Altering Application/Overlay</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-bitstream-and-xclbin">Generate bitstream and .xclbin</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modify-petalinux-to-include-sw-stack-for-filter2d">Modify PetaLinux to include SW stack for filter2d</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-steps-to-generate-shell-json-and-dtbo-file">Optional Steps to Generate shell.json and .dtbo file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-application-on-target">Run Application on Target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="baremetal.html">Bare-metal Flow Example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Common Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="target.html">On-target Utilities and Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootmodes.html">Setting Bootmodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="dtsi_dtbo_generation.html">Generating DTSI and DTBO Overlay Files</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../_sources/docs/vitis_accel_flow_smartcam_filter2d_example.md.txt"
						rel="nofollow">Show Source</a></li>
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kria™ SOM</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
      <li>Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/docs/vitis_accel_flow_smartcam_filter2d_example.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="vitis-accelerator-flow-example-replacing-dpu-with-filter2d-accelerator-in-smartcam-application">
<h1>Vitis Accelerator Flow Example - Replacing DPU with Filter2d Accelerator in Smartcam Application<a class="headerlink" href="#vitis-accelerator-flow-example-replacing-dpu-with-filter2d-accelerator-in-smartcam-application" title="Permalink to this heading">¶</a></h1>
<p>This page will walk you through an example of replacing pre-processing and DPU in <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/docs/smartcamera/smartcamera_landing.html">Smart Camera application</a>
with a simple accelerator (in this case, filter2d) in the Vitis Accelerator Flow. This particular example make use of the Makefile environment provided with <a class="reference external" href="https://github.com/Xilinx/kv260-vitis">kv260_vitis repository</a>. Please first read <a class="reference internal" href="vitis_accel_flow.html"><span class="doc">Vitis Accelerator Flow</span></a> before trying this example.</p>
<p>This example was created with 21.1 tools and BSP. You will need Vitis. This application assumes that you are familiar with Smart Camera application, and have already booted Linux with a Smartcamera application running. If you have not yet done that, please go through <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/docs/smartcamera/smartcamera_landing.html">smartcam application deployment</a>.</p>
<p>This example will generate 2 files - .bit.bin (PL bitstream) and .xclbin file for the specific accelerator. You will re-use .dtbo (device tree overlay), and shell.json file from smartcam platform because we are using the same platform.</p>
<div class="section" id="obtaining-platform">
<h2>Obtaining Platform<a class="headerlink" href="#obtaining-platform" title="Permalink to this heading">¶</a></h2>
<p>Since we are altering smartcam application only and not the platform, we will first need to get the platform smartcam is based on - kv260_ispMipiRx_vcu_DP. Detailed tutorial is at <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/docs/build_vitis_platform.html">Creating Vitis Platform</a>. Here are the specific commands to use to generate the platform:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone --recursive https://github.com/Xilinx/kv260-vitis.git
<span class="nb">cd</span> <span class="nv">$workdir</span>/kv260-vitis
make platform <span class="nv">PFM</span><span class="o">=</span>kv260_ispMipiRx_vcu_DP
</pre></div>
</div>
<p>The platform will be available now in <code class="docutils literal notranslate"><span class="pre">kv260-vitis/platforms/xilinx_kv260_ispMipiRx_vcu_DP_202110_1/</span></code>.</p>
</div>
<div class="section" id="obtaining-filter2d">
<h2>Obtaining filter2d<a class="headerlink" href="#obtaining-filter2d" title="Permalink to this heading">¶</a></h2>
<p>Filter2d RTL kernel can be found <a class="reference external" href="https://gitenterprise.xilinx.com/PAEG/spa_accel/tree/2021.1/examples/filter2d_pl">here</a>. in a seperate folder, please download and extract the filter2d_pl and copy it to smartcam folder:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$workdir</span>
git clone https://gitenterprise.xilinx.com/PAEG/spa_accel
cp spa_accel/examples/filter2d_pl/ kv260-vitis/overlays/examples/smartcam/ -r
</pre></div>
</div>
<p>You may need to update <code class="docutils literal notranslate"><span class="pre">$workdir/kv260-vitis/overlays/examples/smartcam/filter2d_pl/kernel/Makefile</span></code> so that it is pointing to the right include directory:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>XFOPENCV_INCDIR = ../../../vitis_libraries/vision/L1/include
</pre></div>
</div>
<p>may need to be updated to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>XFOPENCV_INCDIR = ../../../../Vitis_Libraries/vision/L1/include
</pre></div>
</div>
</div>
<div class="section" id="altering-application-overlay">
<h2>Altering Application/Overlay<a class="headerlink" href="#altering-application-overlay" title="Permalink to this heading">¶</a></h2>
<p>The next step is to alter the smartcam overlay. This is the overlay folder:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$workdir</span>/kv260-vitis/overlays/examples/smartcam/
</pre></div>
</div>
<p>You will now find a Makefile in that level - open it up and remove DPU and add filter2d. We will first want to remove generation of DPU and its pre-processing. This means removing packing of .xo files for those 2 RTL kernels.</p>
<p>remove the following lines for DPU (in 3 seperate places:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>dpu_HDLSRCS=kernel_xml/dpu/kernel.xml\
	     scripts/package_dpu_kernel.tcl\
	     scripts/gen_dpu_xo.tcl\
	     ../../dpu_ip/Vitis/dpu/hdl/DPUCZDX8G.v\
	     ../../dpu_ip/Vitis/dpu/inc/arch_def.vh\
	     ../../dpu_ip/Vitis/dpu/xdc/*.xdc\
	     ../../dpu_ip/DPUCZDX8G_*/hdl/DPUCZDX8G_*_dpu.sv\
	     ../../dpu_ip/DPUCZDX8G_*/inc/function.vh\
             ../../dpu_ip/DPUCZDX8G_*/inc/arch_para.vh

dpu_TCL=scripts/gen_dpu_xo.tcl
DPU_KERN_NAME = DPUCZDX8G
dpu_xo = binary_container_1/dpu.xo


binary_container_1/dpu.xo: $(dpu_HDLSRCS)
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VIVADO) -mode batch -source $(dpu_TCL) -tclargs $@ $(DPU_KERN_NAME) ${TARGET} mpsoc


	cp ./binary_*/link/vivado/vpl/prj/prj.gen/sources_1/bd/*/ip/*_DPUCZDX8G_1_0/arch.json ./binary_*/sd_card
</pre></div>
</div>
<p>remove the following lines for preprocessing (PP):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>KERNEL = pp_pipeline_accel
KERNEL_XO = $(KERNEL)/$(KERNEL).xo

KERNEL_XO_FLAGS = -k $(KERNEL) -I$(XFOPENCV_INCDIR) -D__SDSVHLS__ -DHLS_NO_XIL_FPO_LIB --advanced.prop kernel.pp_pipeline_accel.kernel_flags=&quot;-std=c++0x&quot;

$(KERNEL_XO): xf_pp_pipeline_accel.cpp
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VPP) $(VPP_XO_FLAGS) -o $@ $&lt;
	-@$(RM) .Xil
</pre></div>
</div>
<p>Add filter2d .xo file generation and Makefile calls in 3 different places:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filter2d_xo = filter2d_pl/kernel/filter2d_pl_accel/filter2d_pl_accel.xo


$(BINARY_CONTAINER): $(filter2d_xo)
	$(VPP) $(VPP_LINK_FLAGS) -o $@ $(+)
	$(XBU) $(XBU_FLAGS) --input $(BINARY_CONTAINER) --output tmp.xclbin
	-@$(MV) tmp.xclbin $(BINARY_CONTAINER)
	-@$(RM) .Xil

$(filter2d_xo):
	$(MAKE) -C filter2d_pl/kernel
 
 
	$(MAKE) -C filter2d_pl/kernel clean
</pre></div>
</div>
<p>Remove invocation for strip_interconnects.tcl as we wont need it:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--xp param:compiler.userPostSysLinkOverlayTcl=${DIR_PRJ}/prj_conf/strip_interconnects.tcl 
</pre></div>
</div>
<p>Replace the 2 kernels with filter2d kernel:
remove <code class="docutils literal notranslate"><span class="pre">dpu_pp_xo</span> <span class="pre">=</span> <span class="pre">$(KERNEL_XO)</span> <span class="pre">$(dpu_xo)</span></code>
add <code class="docutils literal notranslate"><span class="pre">dpu_pp_xo</span> <span class="pre">=</span>&#160; <span class="pre">$(filter2d_xo)</span></code></p>
<p>The resulting Makefile can be found in <a class="reference external" href="./example_src/vitis_accel_example_smartcam_filter2d_makefile">example Makefile</a> you can compare it with the original Makefile <a class="reference external" href="https://github.com/Xilinx/kv260-vitis/blob/release-2021.1/overlays/examples/smartcam/Makefile">here</a></p>
<p>Next, we need to connect the filter2d accelerator to the processor subsystem. Open <code class="docutils literal notranslate"><span class="pre">prj_conf/prj_config_1dpu</span></code>, remove DPUCZDX8G and pp_pipeline_accel_1 clocks and connectivity, and connect filter2d to HP1:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[clock]
#freqHz=300000000:DPUCZDX8G_1.aclk
#freqHz=600000000:DPUCZDX8G_1.ap_clk_2
#freqHz=300000000:pp_pipeline_accel_1.ap_clk
freqHz=200000000:filter2d_pl_accel_0.ap_clk
[connectivity]
#sp=DPUCZDX8G_1.M_AXI_GP0:HP1
#sp=DPUCZDX8G_1.M_AXI_HP0:HP1
#sp=DPUCZDX8G_1.M_AXI_HP2:HPC1
#sp=pp_pipeline_accel_1.m_axi_gmem1:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem2:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem3:HP3
#sp=pp_pipeline_accel_1.m_axi_gmem4:HP3

nk=filter2d_pl_accel:1:filter2d_pl_accel_0
sp=filter2d_pl_accel_0.frm_in:HP1
sp=filter2d_pl_accel_0.frm_out:HP1
sp=filter2d_pl_accel_0.kernel:HP1
</pre></div>
</div>
<p>Now you have finished all the modifications needed to replace preprocessor and DPU with filter2d.</p>
</div>
<div class="section" id="generate-bitstream-and-xclbin">
<h2>Generate bitstream and .xclbin<a class="headerlink" href="#generate-bitstream-and-xclbin" title="Permalink to this heading">¶</a></h2>
<p>You can now call the top level Makefile to generate the files required:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ../../../
make overlay <span class="nv">OVERLAY</span><span class="o">=</span>smartcam
</pre></div>
</div>
<p>The generated vivado project will be located at:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$working_dir</span>/kv260-vitis/overlays/examples/smartcam/binary_container_1/link/vivado/vpl/prj
</pre></div>
</div>
<p>You can open up the Vivado project to see how filter2d is connected into the system.</p>
<p>The generated bitfile and xclbin will be located at</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$working_dir</span>/kv260-vitis/overlays/examples/smartcam/binary_container_1/link/int/system.bit   
<span class="nv">$working_dir</span>/kv260-vitis/overlays/examples/smartcam/binary_container_1/*.xclbin
</pre></div>
</div>
<p>rename .xclbin file to <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code></p>
<p>Now you will need to convert system.bit to a .bit.bin file:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> overlays/examples/smartcam/binary_container_1/link/int/
<span class="nb">echo</span> <span class="s1">&#39;all:{system.bit}&#39;</span>&gt;bootgen.bif
bootgen -w -arch zynqmp -process_bitstream bin -image bootgen.bif
mv system.bit.bin filter2d.bit.bin
</pre></div>
</div>
<p>now you have a <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code> and <code class="docutils literal notranslate"><span class="pre">filter2d.bit.bin</span></code></p>
</div>
<div class="section" id="modify-petalinux-to-include-sw-stack-for-filter2d">
<h2>Modify PetaLinux to include SW stack for filter2d<a class="headerlink" href="#modify-petalinux-to-include-sw-stack-for-filter2d" title="Permalink to this heading">¶</a></h2>
<p>The base PetaLinux for SOM doesnt include the sw stack for filter2d. You will need to create a petalinux project from released bsp, clone the repo with software support for filter2d. You will then copy the notebook folder into recipes folder, add entry to rootfs config, and rebuild PetaLinux.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>petalinux-create -t project -s xilinx-k26-starterkit-v2021.1-final.bsp
git clone --recursive https://github.com/Xilinx/vck190-base-trd.git
cp vck190-base-trd/overlays/filter2d/apps/filter2d-notebooks/ xilinx-k26-starterkit-2021.1/project-spec/meta-user/recipes-apps/ -rf
mkdir xilinx-k26-starterkit-2021.1/project-spec/meta-user/recipes-apps/bigbuckbunny-360p-vp9-webm/
cp vck190-base-trd/petalinux/xilinx-vck190-base-trd/project-spec/meta-base-trd/recipes-multimedia/sample-content/bigbuckbunny-360p-vp9-webm.bb xilinx-k26-starterkit-2021.1/project-spec/meta-user/recipes-apps/bigbuckbunny-360p-vp9-webm/
<span class="nb">cd</span> xilinx-k26-starterkit-2021.1
<span class="nb">echo</span> <span class="s1">&#39;CONFIG_filter2d-notebooks&#39;</span> &gt;&gt; ./project-spec/meta-user/conf/user-rootfsconfig
<span class="nb">echo</span> <span class="s1">&#39;CONFIG_filter2d-notebooks=y&#39;</span> &gt;&gt; ./project-spec/configs/rootfs_config
<span class="nb">echo</span> <span class="s1">&#39;CONFIG_bigbuckbunny-360p-vp9-webm&#39;</span> &gt;&gt; ./project-spec/meta-user/conf/user-rootfsconfig
<span class="nb">echo</span> <span class="s1">&#39;CONFIG_bigbuckbunny-360p-vp9-webm=y&#39;</span> &gt;&gt; ./project-spec/configs/rootfs_config
petalinux-build
petalinux-package --wic --bootfiles <span class="s2">&quot;ramdisk.cpio.gz.u-boot boot.scr Image system.dtb&quot;</span>
</pre></div>
</div>
<p>This generates a wic image, zip up the wic image if you need to move the image to another location before programming sd card</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gzip images/linux/petalinux-sdimage.wic
</pre></div>
</div>
<p>Program the wic image into your SD card. Plug the SD card into KV260’s SD card slot.</p>
</div>
<div class="section" id="optional-steps-to-generate-shell-json-and-dtbo-file">
<h2>Optional Steps to Generate shell.json and .dtbo file<a class="headerlink" href="#optional-steps-to-generate-shell-json-and-dtbo-file" title="Permalink to this heading">¶</a></h2>
<p>Because we are re-using the same platform smartcam application is based on, we can re-use the smartcam shell.json and kv260-smartcam.dtbo file in the firmware folder as indicated in the following section. However, if you prefer, you can also generate them seperatedly. Note that you will still need to download and install smartcam for the software dependencies this example uses.</p>
<p>Shell.json can be generated using the instruction <a class="reference external" href="target.md#shelljson-file">here</a>.</p>
<p>filter2d.dtbo can be generated by using the same <a class="reference external" href="https://github.com/Xilinx/kv260-firmware/blob/release-2021.1/smartcam/kv260-smartcam.dtsi">.dtsi</a> file and compile using <a class="reference external" href="./dtsi_dtbo_generation.md#tools-and-input-required">dtc</a>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dtc -@ -O dtb -o filter2d.dtbo kv260-smartcam.dtsi
</pre></div>
</div>
</div>
<div class="section" id="run-application-on-target">
<h2>Run Application on Target<a class="headerlink" href="#run-application-on-target" title="Permalink to this heading">¶</a></h2>
<p>This application assumes that you are familiar with Smart Camera application, and knows how to booted Linux with a Smartcamera application running. If you have not yet done that, please go through <a class="reference external" href="https://xilinx.github.io/kria-apps-docs/main/build/html/docs/smartcamera/smartcamera_landing.html">smartcam application deployment</a>.  The following commands in target (kv260) will download smartcam and their dependencies:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo dnf clean all
sudo dnf update -y
sudo xmutil getpkgs
sudo dnf install packagegroup-kv260-smartcam.noarch -y
</pre></div>
</div>
<p>With smartcam application downloaded, we have all the software dependencies needed to run gstreamer, as well as the .dtbo file and shell.json file. Note that because we reused the same platform from smartcam, we can re-use the .dtbo file from smartcam.</p>
<p>Transfer  <code class="docutils literal notranslate"><span class="pre">filter2d.xclbin</span></code> and <code class="docutils literal notranslate"><span class="pre">filter2d.bit.bin</span></code> to target kv260 using scp or your chosen method. On target, make a new filter2d directory and copy needed files into directory:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo mkdir /lib/firmware/xilinx/filter2d
sudo cp /lib/firmware/xilinx/kv260-smartcam/kv260-smartcam.dtbo /lib/firmware/xilinx/filter2d/filter2d.dtbo
sudo cp /lib/firmware/xilinx/kv260-smartcam/shell.json /lib/firmware/xilinx/filter2d/
sudo cp filter2d.bit.bin /lib/firmware/xilinx/filter2d/
sudo cp filter2d.xclbin /lib/firmware/xilinx/filter2d/
</pre></div>
</div>
<p>modify  <code class="docutils literal notranslate"><span class="pre">/usr/share/ivas/base-trd/kernel_xfilter2d_pl.json</span></code> so that <code class="docutils literal notranslate"><span class="pre">xclbin-location</span></code> points to ```filter2d.xclbin`` location.
Now load the new application:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo xmutil unloadapp
sudo xmutil loadapp filter2d
</pre></div>
</div>
<p>Now first try running gstreamer with the accelerator by-passed to make sure things work fine, you should expect to see the monitor displaying what it captured in MIPI. This command assumes that we use a MIPI camera mapped to media0, and that monitor supports 1920x1080p:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gst-launch-1.0 mediasrcbin media-device<span class="o">=</span>/dev/media0 v4l2src0::io-mode<span class="o">=</span>mmap ! <span class="s2">&quot;video/x-raw, width=1920, height=1080, format=NV12, framerate=30/1&quot;</span> ! perf ! kmssink plane-id<span class="o">=</span><span class="m">39</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span> -v
</pre></div>
</div>
<p>This confirms that the monitor is working as expected.</p>
<p>Next, try running using filter2d in the PL. The filter2d accelerator we included only takes YuY2 format, while our MIPI sensors are in NV12 format. Therefore, we need to find a compatible video to try the filter2d with. In this case we googled and downloaded bbb_sunflower_1080p_30fps_normal.mp4 from <a class="reference external" href="https://mirror.clarkson.edu/blender/demo/movies/BBB/">online</a> and placed them in /home/petalinux/bbb_sunflower_1080p_30fps_normal.mp4. Then we can execute the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gst-launch-1.0 filesrc <span class="nv">location</span><span class="o">=</span><span class="s2">&quot;bbb_sunflower_1080p_30fps_normal.mp4&quot;</span> ! decodebin ! videoconvert ! video/x-raw, <span class="nv">width</span><span class="o">=</span><span class="m">1920</span>, <span class="nv">height</span><span class="o">=</span><span class="m">1080</span>, <span class="nv">format</span><span class="o">=</span>YUY2, <span class="nv">framerate</span><span class="o">=</span><span class="m">30</span>/1 ! ivas_xfilter kernels-config<span class="o">=</span>/usr/share/ivas/base-trd/kernel_xfilter2d_pl.json dynamic-config<span class="o">=</span><span class="s1">&#39;{ &quot;filter_preset&quot; : &quot;edge&quot; }&#39;</span> ! perf ! kmssink driver-name<span class="o">=</span>xlnx plane-id<span class="o">=</span><span class="m">39</span> fullscreen-overlay<span class="o">=</span><span class="nb">true</span> <span class="nv">sync</span><span class="o">=</span><span class="nb">false</span> -v
</pre></div>
</div>
<p>You should be able to see a the video being displayed with filter_preset set to “edge”. You can try other presents as well, the list can be found <a class="reference external" href="https://github.com/Xilinx/vck190-base-trd/blob/c18ebb34b7828e47a33bfb3c7a0899f3d7c77d13/overlays/filter2d/apps/filter2d-notebooks/filter2d-notebooks/ivas-accel-sw-libs/ivas_xfilter2d_pl/src/ivas_xfilter2d.h#L50">here</a>. If there are spaces in preset, replease it with underscore. For an example, <code class="docutils literal notranslate"><span class="pre">horizontal</span> <span class="pre">edge</span></code> should be <code class="docutils literal notranslate"><span class="pre">horizontal_edge</span></code> in above command.  The framerate being displayed will be slow - we had to do format convertation in software, therefore each frame will take time.</p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this heading">¶</a></h2>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License.</p>
<p>You may obtain a copy of the License at
<a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p align="center">Copyright&copy; 2021 Xilinx</p></div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="baremetal.html" class="btn btn-neutral float-right" title="Bare-metal Flow Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vitis_accel_vadd_example.html" class="btn btn-neutral float-left" title="Vitis Accelerator Flow Example - Adding VADD Accelerator using Vitis GUI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on June 23, 2022.
      </span>

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
														
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<div class="lang-select dropup hidden-md hidden-lg">
		<button data-toggle="dropdown">
			<span class="fas fa-globe" aria-hidden="true"></span>
			<span>
				
					English
				</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a target="_blank" href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a target="_blank" href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a target="_blank" href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
																	<div class="lang-select dropup hidden-xs hidden-sm">
	<button data-toggle="dropdown">
		<span class="fas fa-globe" aria-hidden="true"></span>
		<span>
			
				English
			</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a target="_blank" href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a target="_blank" href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
															</div>
														</div>
														<div class="col-md-pull-5 col-lg-pull-5 col-md-5 col-lg-5">
															<span class="copyright">©2022 Advanced Micro Devices, Inc</span>
														</div>

													</div>
													                    <div class="movethisrowtoleft row">
                        <div class="col-xs-24">
                            <ul class="sub-menu">
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a></li>
                                <li><a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a></li>
                                <li><a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a></li>
								<li><a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a></li>
                                <li><a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></li>
                            </ul>
                        </div>
                    </div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
<div class="backToTop parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><noindex>
    <span data-component="backToTopButton" class="backToTopButton loaded">
        <ul>
            <li>
                <a href="https://www.author.xilinx.com/xx/rebrand/amd/en-amd-xilinx-header-footer.html#top" class="btn top">
                    <span class="fas fa-angle-up" aria-hidden="true"></span>
                </a>
            </li>
        </ul>
    </span>
</noindex></div>
			</div>
		</div>


		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>